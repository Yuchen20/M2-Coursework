

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Evaluating Trained LLM Performance on Time Series Forecasting &mdash; Time Series Forecasting with LLMs beta documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=d2d258e8" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=a6e103b4" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=f0d2c090"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Evaluating Fully Trained LLM Performance on Time Series Forecasting" href="6_fully_trained_behaviour.html" />
    <link rel="prev" title="Train LoRA-LLM" href="4_train_lora_llm.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Time Series Forecasting with LLMs
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Jupyter Notebooks</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="1_dataset_preprocess.html">Lotka-Volterra Dataset Exploration &amp; LLMTIME Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="2_flops_calculation.html">Understanding FLOPS Calculation for Qwen2.5 Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="3_untrained_behaviour.html">Evaluating Untrained LLM Performance on Time Series Forecasting</a></li>
<li class="toctree-l1"><a class="reference internal" href="4_train_lora_llm.html">Train LoRA-LLM</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Evaluating Trained LLM Performance on Time Series Forecasting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Data-Preparation">Data Preparation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Zero-Shot-Forecasting-Evaluation">Zero-Shot Forecasting Evaluation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Flops-Analysis">Flops Analysis</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Results-Analysis">Results Analysis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="6_fully_trained_behaviour.html">Evaluating Fully Trained LLM Performance on Time Series Forecasting</a></li>
<li class="toctree-l1"><a class="reference internal" href="6_fully_trained_behaviour.html#Flops-Analysis">Flops Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="7_weight_visualize.html">LM Bias Weight Visualization</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Time Series Forecasting with LLMs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Evaluating Trained LLM Performance on Time Series Forecasting</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks/5_initial_train_behaviour.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="admonition note">
<p class="admonition-title">Note</p>
<p>This page was generated from a Jupyter notebook.
<a class="reference external" href="https://github.com/yourusername/time_series_llm/blob/main/notebooks5_initial_train_behaviour.ipynb">View the original notebook</a></p>
</div>
<section id="Evaluating-Trained-LLM-Performance-on-Time-Series-Forecasting">
<h1>Evaluating Trained LLM Performance on Time Series Forecasting<a class="headerlink" href="#Evaluating-Trained-LLM-Performance-on-Time-Series-Forecasting" title="Link to this heading"></a></h1>
<p>This notebook examines the initially trained performance of the Qwen2.5-0.5B-Instruct model on predator-prey time series forecasting. The overall structure of this notebook is a direct copy of the <code class="docutils literal notranslate"><span class="pre">notebooks\3_untrained_behaviour.ipynb</span></code> script, with the exception of loading in the weights of <strong>LoRA</strong> into the model. The model is evaluated on the same time series forecasting tasks as in the original notebook.</p>
<p>In the cell below, we have loaded the weights of the <strong>LoRA</strong> model into the Qwen2.5-0.5B-Instruct model using the <code class="docutils literal notranslate"><span class="pre">load_checkpoint</span></code> function. This function loads the weights from the specified checkpoint file into the model.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoModelForCausalLM</span><span class="p">,</span> <span class="n">AutoTokenizer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__name__</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span> <span class="s1">&#39;src&#39;</span><span class="p">)))</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">get_flops</span><span class="w"> </span><span class="kn">import</span> <span class="n">QwenFlopsCalculator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">get_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">LotkaVolterraDataset</span><span class="p">,</span> <span class="n">DataMaster</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">preprocessor</span><span class="w"> </span><span class="kn">import</span> <span class="n">NumericalProcessor</span>


<span class="k">class</span><span class="w"> </span><span class="nc">LoRALinear</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LoRA implementation for linear layers.</span>
<span class="sd">    Adds low-rank adaptation matrices to an existing linear layer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_linear</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">original_linear</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_linear</span> <span class="o">=</span> <span class="n">original_linear</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_linear</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_linear</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">original_linear</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">in_dim</span> <span class="o">=</span> <span class="n">original_linear</span><span class="o">.</span><span class="n">in_features</span>
        <span class="n">out_dim</span> <span class="o">=</span> <span class="n">original_linear</span><span class="o">.</span><span class="n">out_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span> <span class="k">if</span> <span class="n">alpha</span> <span class="k">else</span> <span class="n">r</span>

        <span class="n">device</span> <span class="o">=</span> <span class="n">original_linear</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">in_dim</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">out_dim</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>

        <span class="c1"># Initialise A with He initialization</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">kaiming_normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">nonlinearity</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">merged_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_linear</span><span class="o">.</span><span class="n">weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_merged</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_merged</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">merged_weight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_linear</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>

        <span class="n">base_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_linear</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">lora_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">base_out</span> <span class="o">+</span> <span class="n">lora_out</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merged_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_linear</span><span class="o">.</span><span class="n">weight</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_merged</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">unmerge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_merged</span> <span class="o">=</span> <span class="kc">False</span>


<span class="c1"># models</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_qwen</span><span class="p">():</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;Qwen/Qwen2.5-0.5B-Instruct&quot;</span>
    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Freeze all parameters except LM head bias</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
        <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Add trainable bias to logits</span>
    <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">lm_head</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="n">model</span><span class="o">.</span><span class="n">lm_head</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">lm_head</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span>

<span class="k">def</span><span class="w"> </span><span class="nf">apply_lora</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lora_rank</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply LoRA to specific layers in the model.&quot;&quot;&quot;</span>
    <span class="c1"># Re-freeze all model parameters to be sure</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
        <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Apply LoRA to query and value projection layers</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">self_attn</span><span class="o">.</span><span class="n">q_proj</span> <span class="o">=</span> <span class="n">LoRALinear</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">self_attn</span><span class="o">.</span><span class="n">q_proj</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">lora_rank</span><span class="p">)</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">self_attn</span><span class="o">.</span><span class="n">v_proj</span> <span class="o">=</span> <span class="n">LoRALinear</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">self_attn</span><span class="o">.</span><span class="n">v_proj</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">lora_rank</span><span class="p">)</span>

    <span class="c1"># Make sure the LM head bias remains trainable</span>
    <span class="n">model</span><span class="o">.</span><span class="n">lm_head</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">model</span>

<span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">load_qwen</span><span class="p">()</span>

<span class="c1"># Fixed hyperparameters as specified</span>
<span class="n">context_length</span> <span class="o">=</span> <span class="mi">768</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">max_steps</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">eval_interval</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">target_eval_pairs</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">experiment_fraction</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">test_size</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">val_size</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="n">lora_rank</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">max_budget</span> <span class="o">=</span> <span class="mi">40</span>



<span class="n">model</span> <span class="o">=</span> <span class="n">apply_lora</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lora_rank</span><span class="p">)</span>


<span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;../checkpoint/checkpoint_initial_run.pth&#39;</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">weights_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">load_checkpoint</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a model checkpoint.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load model weights</span>
        <span class="n">model_state_dict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">model_state_dict</span><span class="p">:</span>
                <span class="n">model_state_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">model_state_dict</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded checkpoint successfully&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while applying checkpoint: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Continuing with original model without loading checkpoint.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span>

<span class="c1"># Apply the checkpoint to the model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">)</span>

<span class="c1"># some nice function for GPU Training</span>
<span class="k">def</span><span class="w"> </span><span class="nf">clear_memory</span><span class="p">():</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">):</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">ipc_collect</span><span class="p">()</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">reset_peak_memory_stats</span><span class="p">()</span>

<span class="c1"># device</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

<span class="c1"># random seed</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Loaded checkpoint successfully
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">self_attn</span><span class="o">.</span><span class="n">q_proj</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Parameter containing:
tensor([[ 0.0717,  0.0424,  0.0344,  ..., -0.0204, -0.0587, -0.0337],
        [-0.0318, -0.0047,  0.0269,  ...,  0.0321,  0.0089,  0.0172],
        [ 0.0093,  0.0504,  0.0139,  ..., -0.0119,  0.0471, -0.0039],
        [ 0.0167, -0.0044, -0.0041,  ..., -0.0023, -0.0263, -0.0074]],
       device=&#39;cuda:0&#39;, requires_grad=True)
</pre></div></div>
</div>
<section id="Data-Preparation">
<h2>Data Preparation<a class="headerlink" href="#Data-Preparation" title="Link to this heading"></a></h2>
<p>For efficient experimentation, we use the <code class="docutils literal notranslate"><span class="pre">DataMaster</span></code> class which handles:</p>
<ul class="simple">
<li><p>Loading the Lotka-Volterra predator-prey time series data</p></li>
<li><p>Preprocessing numerical data using the LLMTIME scheme</p></li>
<li><p>Creating appropriate train/validation/test splits</p></li>
<li><p>Building PyTorch DataLoaders with configurable parameters</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">experiment_fraction=0.1</span></code> parameter allows us to work with a smaller subset of data (10%) for faster iteration during development. In our final evaluation, we can scale this up to use the complete dataset by setting it to 1.0.</p>
<p>The context length parameter controls how much historical data the model sees when making predictions. Varying this parameter helps us understand the model’s sensitivity to context window size, which is important for both performance optimization and FLOPS budget management.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %%</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="c1"># Load the data</span>


<span class="c1"># data folder:</span>
<span class="n">DATA_FOLDER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__name__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>


<span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_FOLDER</span><span class="p">,</span> <span class="s1">&#39;lotka_volterra_data.h5&#39;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="c1"># Access the full dataset</span>
    <span class="n">trajectories</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;trajectories&quot;</span><span class="p">][:]</span>
    <span class="n">time_points</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][:]</span>

<span class="c1"># Here we are only using a small fraction of the data for the experiment</span>
<span class="n">data_master</span> <span class="o">=</span> <span class="n">DataMaster</span><span class="p">(</span>
    <span class="n">tokenizer</span><span class="p">,</span> <span class="n">trajectories</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">val_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">experiment_fraction</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Zero-Shot-Forecasting-Evaluation">
<h2>Zero-Shot Forecasting Evaluation<a class="headerlink" href="#Zero-Shot-Forecasting-Evaluation" title="Link to this heading"></a></h2>
<p>Now we evaluate the untrained Qwen2.5-0.5B model on predator-prey time series forecasting. The evaluation procedure:</p>
<ol class="arabic simple">
<li><p><strong>Sequential Prediction</strong>: We provide the model with initial context (e.g., 128 tokens) and let it autoregressively generate predictions</p></li>
<li><p><strong>Termination Criteria</strong>: The model generates tokens until either:</p>
<ul class="simple">
<li><p>It produces a maximum of <code class="docutils literal notranslate"><span class="pre">semi_colon_max</span></code> semicolons (<strong>indicating how many complete timestamps of (predator, prey) pairs we want to forecast</strong>)</p></li>
</ul>
</li>
<li><p><strong>Metric Calculation</strong>: We decode the generated tokens back to numerical values and compute:</p>
<ul class="simple">
<li><p>Mean Squared Error (MSE): Measures average squared difference between predictions and ground truth</p></li>
<li><p>Mean Absolute Error (MAE): Measures average absolute difference</p></li>
<li><p>Time-indexed metrics: Track how errors evolve over sequential prediction steps</p></li>
</ul>
</li>
</ol>
<p>We evaluate across multiple context window sizes (128, 512, 768) to understand how the amount of historical context affects forecasting accuracy. This gives us insights into the model’s inherent temporal reasoning capabilities and memory limitations.</p>
<p>All FLOPS usage is carefully tracked to ensure we stay within our computational budget of 10^17 FLOPS.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %%</span>

<span class="n">processor</span> <span class="o">=</span> <span class="n">data_master</span><span class="o">.</span><span class="n">processor</span>

<span class="n">flops_logger</span> <span class="o">=</span> <span class="n">QwenFlopsCalculator</span><span class="p">()</span>


<span class="n">Total_flops_used</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Flops_counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>


<span class="n">logged_metrics</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">):</span>
    <span class="n">semi_colon_max</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MSE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MAE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MSE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">_per_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MAE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">_per_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;CE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">_per_token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>


    <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="n">data_master</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span>
        <span class="n">context_length</span><span class="o">=</span><span class="n">context_length</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">target_eval_pairs</span> <span class="o">=</span> <span class="n">semi_colon_max</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="p">)</span>

    <span class="n">loader</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">test_loader</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">loader</span><span class="p">:</span>

        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># we allow the model infer until (reached 2 * target length) or the model predict the end token (semi-colon token -&gt; 26)</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="n">semi_colon_max</span> <span class="o">*</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">original_length</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">semi_colon_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">per_step_ce</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_length</span><span class="p">):</span>

                <span class="n">flops_logger</span><span class="o">.</span><span class="n">log_flops</span><span class="p">(</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">seq_len</span><span class="o">=</span><span class="n">context_length</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">inference</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;MSE Untrained Evaluation&quot;</span><span class="p">)</span>

                <span class="c1"># only use context length size of input_ids to predict the next token</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_ids</span><span class="p">[:,</span> <span class="o">-</span><span class="n">context_length</span><span class="p">:])</span>
                <span class="n">next_token_logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">logits</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">next_token</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">next_token_logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">next_token</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># get the CE loss</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">next_token_logits</span><span class="p">,</span> <span class="n">target</span><span class="p">[:,</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">original_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">per_step_ce</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

                <span class="k">if</span> <span class="n">next_token</span> <span class="o">==</span> <span class="mi">26</span><span class="p">:</span>
                    <span class="n">semi_colon_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">semi_colon_count</span> <span class="o">==</span> <span class="n">semi_colon_max</span><span class="p">:</span>
                        <span class="k">break</span>

        <span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;CE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">_per_token&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">per_step_ce</span><span class="p">)</span>


        <span class="c1"># convert to numpy</span>
        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="c1"># postprocess</span>
        <span class="n">predicted_values</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">decode_to_string</span><span class="p">(</span><span class="n">input_ids</span><span class="p">[</span><span class="n">original_length</span><span class="p">:])</span>
        <span class="n">target_values</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">decode_to_string</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="c1"># for both get the first semi-colon and use any value after that</span>
        <span class="n">predicted_values</span> <span class="o">=</span> <span class="n">predicted_values</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">semi_colon_count</span><span class="p">]</span>
        <span class="n">predicted_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">pred_val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">pred_val</span> <span class="ow">in</span> <span class="n">predicted_values</span><span class="p">]</span>
        <span class="n">predicted_values</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">pred_val</span><span class="p">]</span> <span class="k">for</span> <span class="n">pred_val</span> <span class="ow">in</span> <span class="n">predicted_values</span><span class="p">]</span>
        <span class="n">predicted_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">predicted_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">predicted_values</span> <span class="o">=</span> <span class="n">predicted_values</span> <span class="o">/</span> <span class="n">processor</span><span class="o">.</span><span class="n">scaler</span>

        <span class="n">target_values</span> <span class="o">=</span> <span class="n">target_values</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">semi_colon_count</span><span class="p">]</span>
        <span class="n">target_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">tar_val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">tar_val</span> <span class="ow">in</span> <span class="n">target_values</span><span class="p">]</span>
        <span class="n">target_values</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">tar_val</span><span class="p">]</span> <span class="k">for</span> <span class="n">tar_val</span> <span class="ow">in</span> <span class="n">target_values</span><span class="p">]</span>
        <span class="n">target_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">target_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">target_values</span> <span class="o">=</span> <span class="n">target_values</span> <span class="o">/</span> <span class="n">processor</span><span class="o">.</span><span class="n">scaler</span>


        <span class="n">mse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">predicted_values</span> <span class="o">-</span> <span class="n">target_values</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">predicted_values</span> <span class="o">-</span> <span class="n">target_values</span><span class="p">))</span>

        <span class="n">mse_per_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">predicted_values</span> <span class="o">-</span> <span class="n">target_values</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mae_per_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">predicted_values</span> <span class="o">-</span> <span class="n">target_values</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MSE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">_per_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mse_per_time</span><span class="p">)</span>
        <span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MAE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">_per_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mae_per_time</span><span class="p">)</span>

        <span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MSE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mse</span><span class="p">)</span>
        <span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MAE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mae</span><span class="p">)</span>

        <span class="n">loader</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;MSE: </span><span class="si">{</span><span class="n">mse</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, MAE: </span><span class="si">{</span><span class="n">mae</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>



    <span class="n">flops_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">flops_logger</span><span class="o">.</span><span class="n">log_file</span><span class="p">)</span>
    <span class="n">current_exp_flops</span> <span class="o">=</span> <span class="n">flops_df</span><span class="p">[</span><span class="n">flops_df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">flops_logger</span><span class="o">.</span><span class="n">log_name</span><span class="p">]</span>
    <span class="n">Total_flops_used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">current_exp_flops</span><span class="o">.</span><span class="n">flops</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">Flops_counter</span>
    <span class="p">)</span>
    <span class="n">Flops_counter</span> <span class="o">=</span> <span class="n">current_exp_flops</span><span class="o">.</span><span class="n">flops</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>


<span class="c1"># pad the perstep CE to the same length</span>
<span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;CE_128_per_token&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">logged_metrics</span><span class="p">:</span>
    <span class="k">if</span> <span class="s1">&#39;CE&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
            <span class="n">logged_metrics</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>


<span class="c1"># print the Total_flops_used</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">flops</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Total_flops_used</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total FLOPS used for context length </span><span class="si">{</span><span class="p">[</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">512</span><span class="p">,</span><span class="w"> </span><span class="mi">768</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">flops</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">, -- [</span><span class="si">{</span><span class="n">flops</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1e17</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> percent of budget]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 3200 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 400 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 400 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train:   0%|          | 0/3200 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 3200/3200 [00:00&lt;00:00, 24283.88it/s]
Sanity check:  33%|███▎      | 1/3 [00:00&lt;00:00,  7.48it/s]
Sanity check Val: 100%|██████████| 400/400 [00:00&lt;00:00, 23951.37it/s]

Sanity check Test: 100%|██████████| 400/400 [00:00&lt;00:00, 24202.91it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 1604 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 200 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 200 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 1604/1604 [00:00&lt;00:00, 23236.34it/s]

Sanity check Val: 100%|██████████| 200/200 [00:00&lt;00:00, 22544.57it/s]

Sanity check Test: 100%|██████████| 200/200 [00:00&lt;00:00, 23216.56it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 804 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 100 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 100 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 804/804 [00:00&lt;00:00, 22901.33it/s]

Sanity check Val: 100%|██████████| 100/100 [00:00&lt;00:00, 20610.83it/s]

Sanity check Test: 100%|██████████| 100/100 [00:00&lt;00:00, 21137.45it/s]

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Total FLOPS used for context length 128: 3.502e+15, -- [3.502 percent of budget]
Total FLOPS used for context length 512: 7.327e+15, -- [7.327 percent of budget]
Total FLOPS used for context length 768: 5.386e+15, -- [5.386 percent of budget]
</pre></div></div>
</div>
<p>Now, we can show the results of the evaluation. We will display the MSE and MAE for each context window size, as well as the time-indexed metrics to understand how the model’s forecasting performance degrades over time.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context Length: </span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># print(f&#39;CE per token: {np.mean(logged_metrics[f&quot;CE_{context_length}_per_token&quot;])}&#39;)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MSE: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;MSE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s2">_per_time&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">, MAE: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;MAE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s2">_per_time&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MSE per time: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;MSE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s2">_per_time&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MAE per time: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;MAE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s2">_per_time&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">()</span>


<span class="c1"># Plot 1: MSE and MAE degradation over time for each context length</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">context_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">]</span>
<span class="n">time_steps</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># 0 to 4 time steps</span>

<span class="c1"># Plot MSE degradation over time</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">context_lengths</span><span class="p">):</span>
    <span class="n">mse_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MSE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">_per_time&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span> <span class="n">mse_values</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Context Length </span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;MSE Degradation Over Time&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time Step&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Squared Error&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Plot MAE degradation over time</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">context_lengths</span><span class="p">):</span>
    <span class="n">mae_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MAE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">_per_time&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span> <span class="n">mae_values</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Context Length </span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;MAE Degradation Over Time&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time Step&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Absolute Error&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Plot 2: MSE and MAE vs context length</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">mse_by_context</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MSE_</span><span class="si">{</span><span class="n">cl</span><span class="si">}</span><span class="s1">_per_time&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">context_lengths</span><span class="p">]</span>
<span class="n">mae_by_context</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MAE_</span><span class="si">{</span><span class="n">cl</span><span class="si">}</span><span class="s1">_per_time&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">context_lengths</span><span class="p">]</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">context_lengths</span><span class="p">,</span> <span class="n">mse_by_context</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MSE&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">context_lengths</span><span class="p">,</span> <span class="n">mae_by_context</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MAE&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Error Metrics by Context Length&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Context Length&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Error Value&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">context_lengths</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/><br/><br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
==================================================
Context Length: 128
MSE: 0.135554, MAE: 0.174634
MSE per time: [0.00698984 0.03027051 0.08795378 0.19590111 0.35665712]
MAE per time: [0.04241317 0.09028841 0.15818435 0.24274382 0.33954135]

==================================================
Context Length: 512
MSE: 0.036210, MAE: 0.083372
MSE per time: [0.00255047 0.00985967 0.02352411 0.04845199 0.09666347]
MAE per time: [0.02780316 0.05279313 0.08084267 0.11168491 0.1437386 ]

==================================================
Context Length: 768
MSE: 0.029675, MAE: 0.065142
MSE per time: [0.00107841 0.00563559 0.01625338 0.03923728 0.08616945]
MAE per time: [0.01835747 0.03913796 0.06242362 0.08743417 0.11835846]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_5_initial_train_behaviour_8_1.png" src="../_images/notebooks_5_initial_train_behaviour_8_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_5_initial_train_behaviour_8_2.png" src="../_images/notebooks_5_initial_train_behaviour_8_2.png" />
</div>
</div>
<p>Here, we can see a clear trend: as the <strong>context window size increases, the model’s forecasting performance improves</strong>. This is expected, as the model has more historical data to base its predictions on. However, the improvement is not linear, indicating that the model may struggle with long-range dependencies or memory limitations. This information will be crucial for fine-tuning the model and optimizing its performance on this task.</p>
<p>Also, <strong>as the model generates predictions further into the future, the forecasting error increases</strong>. This is expected, as the model is making predictions based on its own generated outputs, which may introduce compounding errors. This trend is important to consider when designing forecasting systems that rely on autoregressive models.</p>
<p>Finally, for the cross-entropy loss, <strong>we can see that there is a interesting zig-zag pattern</strong>. Notice that the loss sometimes reaches zero, and then jumps back up. <strong>The zero is due to the fact that the model have learnt that after a few steps, there must be a semicolon, and then the pattern repeats</strong>. The semi-colon, the comma and the period are quite predictable tokens, and the model can learn to generalize them quite well. However, for the numerical values, the model struggles more, and the
loss increases as the model tries to predict into the future.</p>
<p>When we apply a moving average of 10 steps to the loss, we can see that the zig-zag pattern is smoothed out, and we can see a more clear trend of the loss increasing over time. This is a common technique to visualize trends in noisy data, and can help us understand the overall performance of the model better. We can additionally see that again the model performs better with a larger context window, as it has more information to base its predictions on.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flops_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">flops_logger</span><span class="o">.</span><span class="n">log_file</span><span class="p">)</span>
<span class="n">flops_used</span> <span class="o">=</span> <span class="n">flops_df</span><span class="p">[</span><span class="n">flops_df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">flops_logger</span><span class="o">.</span><span class="n">log_name</span><span class="p">]</span><span class="o">.</span><span class="n">flops</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FLOPS used: </span><span class="si">{</span><span class="n">flops_used</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> or 1e</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">flops_used</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">. Using </span><span class="si">{</span><span class="n">flops_used</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1e17</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% of the Budget&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
FLOPS used: 16215265596896896 or 1e16.21. Using 16.22% of the Budget
</pre></div></div>
</div>
<section id="Flops-Analysis">
<h3>Flops Analysis<a class="headerlink" href="#Flops-Analysis" title="Link to this heading"></a></h3>
<p>Our analysis shows that even using only 1% of the data (10 % of the evaluation set, where the evaluation set is 10% of the entire dataset) already consumes 1.3% of the total computational budget, meaning each validation experiment costs approximately 0.4% of our budget. Since validation will be run multiple times in an experiment, and we have at least 12 experiments planned (3 [rank search] × 3 [learning rate search] + 3 [context length search]), this approach to validation is computationally
expensive.</p>
<p>Therefore, I propose reducing the forecast horizon from 5 to 3 timestamps. This modification will decrease FLOPS usage by approximately 40%, making our experiments significantly more efficient.</p>
<p>This decision is supported by our observations: for the first 2 timestamps, MSE and MAE are relatively similar across different context lengths. However, as error propagates, the third timestamp is where performance between models begins to meaningfully diverge. The plots above demonstrate a clear difference in MSE and MAE values at the third timestamp, making it a suitable evaluation point while conserving computational resources.</p>
<p>Below, we show the updated results for the 3-timestamp forecast horizon.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot 2: MSE and MAE vs context length</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">mse_by_context</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MSE_</span><span class="si">{</span><span class="n">cl</span><span class="si">}</span><span class="s1">_per_time&#39;</span><span class="p">])[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">context_lengths</span><span class="p">]</span>
<span class="n">mae_by_context</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MAE_</span><span class="si">{</span><span class="n">cl</span><span class="si">}</span><span class="s1">_per_time&#39;</span><span class="p">])[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">context_lengths</span><span class="p">]</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">context_lengths</span><span class="p">,</span> <span class="n">mse_by_context</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MSE&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">context_lengths</span><span class="p">,</span> <span class="n">mae_by_context</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MAE&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Error Metrics by Context Length&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Context Length&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Error Value&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">context_lengths</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">for</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context Length: </span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;MSE: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;MSE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s2">_per_time&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:</span><span class="mi">3</span><span class="p">])</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;MAE: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;MAE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s2">_per_time&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:</span><span class="mi">3</span><span class="p">])</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_5_initial_train_behaviour_12_0.png" src="../_images/notebooks_5_initial_train_behaviour_12_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
==================================================
Context Length: 128, MSE: 0.042, MAE: 0.097
==================================================
Context Length: 512, MSE: 0.012, MAE: 0.054
==================================================
Context Length: 768, MSE: 0.008, MAE: 0.040
</pre></div></div>
</div>
</section>
</section>
<section id="Results-Analysis">
<h2>Results Analysis<a class="headerlink" href="#Results-Analysis" title="Link to this heading"></a></h2>
<p>The metrics above reveal how accurately the untrained Qwen2.5-0.5B model can forecast predator-prey dynamics. Several observations:</p>
<ol class="arabic simple">
<li><p><strong>Context Length Impact</strong>: We can see how prediction accuracy varies with different context window sizes.</p></li>
<li><p><strong>Error Progression</strong>: The per-timestep metrics show how errors accumulate (or potentially stabilize) as the model predicts further into the future.</p></li>
<li><p><strong>Overall Performance</strong>: The aggregate MSE and MAE values establish our baseline performance, which we’ll aim to improve through LoRA fine-tuning.</p></li>
<li><p><strong>FLOPS Accounting</strong>: We’ve carefully tracked all computational costs to ensure our experiments remain within budget constraints.</p></li>
</ol>
<p>These baseline results inform our fine-tuning strategy by highlighting:</p>
<ul class="simple">
<li><p>The optimal context window size for balancing performance and computational efficiency</p></li>
<li><p>The model’s inherent limitations on temporal forecasting</p></li>
<li><p>Specific patterns where the model struggles most (which may require dedicated attention during fine-tuning)</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get the first two chain</span>
<span class="n">datas</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">predicted</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">semi_colon_max</span> <span class="o">=</span> <span class="mi">20</span>
<span class="k">for</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">):</span>
    <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="n">data_master</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span>
        <span class="n">context_length</span><span class="o">=</span><span class="n">context_length</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">target_eval_pairs</span> <span class="o">=</span> <span class="n">semi_colon_max</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">temp_test_loader_active</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">test_loader</span><span class="p">)</span>
    <span class="n">datas</span><span class="p">[</span><span class="n">context_length</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="n">temp_test_loader_active</span><span class="p">)]</span>
    <span class="n">datas</span><span class="p">[</span><span class="n">context_length</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">temp_test_loader_active</span><span class="p">))</span>




<span class="n">processor</span> <span class="o">=</span> <span class="n">data_master</span><span class="o">.</span><span class="n">processor</span>

<span class="n">flops_logger</span> <span class="o">=</span> <span class="n">QwenFlopsCalculator</span><span class="p">()</span>


<span class="n">Total_flops_used</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Flops_counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>



<span class="k">for</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">):</span>
    <span class="n">result</span><span class="p">[</span><span class="n">context_length</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="n">data_master</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span>
        <span class="n">context_length</span><span class="o">=</span><span class="n">context_length</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">target_eval_pairs</span> <span class="o">=</span> <span class="n">semi_colon_max</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="p">)</span>
    <span class="c1"># claer tqdm instance</span>
    <span class="n">tqdm</span><span class="o">.</span><span class="n">_instances</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">datas</span><span class="p">[</span><span class="n">context_length</span><span class="p">]:</span>

        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># we allow the model infer until (reached 2 * target length) or the model predict the end token (semi-colon token -&gt; 26)</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="n">semi_colon_max</span> <span class="o">*</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">original_length</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">semi_colon_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">per_step_ce</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_length</span><span class="p">):</span>

                <span class="n">flops_logger</span><span class="o">.</span><span class="n">log_flops</span><span class="p">(</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">seq_len</span><span class="o">=</span><span class="n">context_length</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">inference</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;MSE Untrained Evaluation&quot;</span><span class="p">)</span>

                <span class="c1"># only use context length size of input_ids to predict the next token</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_ids</span><span class="p">[:,</span> <span class="o">-</span><span class="n">context_length</span><span class="p">:])</span>
                <span class="n">next_token_logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">logits</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">next_token</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">next_token_logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">next_token</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># get the CE loss</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">next_token_logits</span><span class="p">,</span> <span class="n">target</span><span class="p">[:,</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">original_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">per_step_ce</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

                <span class="k">if</span> <span class="n">next_token</span> <span class="o">==</span> <span class="mi">26</span><span class="p">:</span>
                    <span class="n">semi_colon_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">semi_colon_count</span> <span class="o">==</span> <span class="n">semi_colon_max</span><span class="p">:</span>
                        <span class="k">break</span>

        <span class="n">result</span><span class="p">[</span><span class="n">context_length</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_ids</span><span class="p">[:,</span> <span class="n">original_length</span><span class="p">:]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>


    <span class="n">flops_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">flops_logger</span><span class="o">.</span><span class="n">log_file</span><span class="p">)</span>
    <span class="n">current_exp_flops</span> <span class="o">=</span> <span class="n">flops_df</span><span class="p">[</span><span class="n">flops_df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">flops_logger</span><span class="o">.</span><span class="n">log_name</span><span class="p">]</span>
    <span class="n">Total_flops_used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">current_exp_flops</span><span class="o">.</span><span class="n">flops</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">Flops_counter</span>
    <span class="p">)</span>
    <span class="n">Flops_counter</span> <span class="o">=</span> <span class="n">current_exp_flops</span><span class="o">.</span><span class="n">flops</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>


<span class="c1"># print the Total_flops_used</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">flops</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Total_flops_used</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total FLOPS used for context length </span><span class="si">{</span><span class="p">[</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">512</span><span class="p">,</span><span class="w"> </span><span class="mi">768</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">flops</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">, -- [</span><span class="si">{</span><span class="n">flops</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1e17</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> percent of budget]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 3200 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 300 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 300 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train:   0%|          | 0/3200 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 3200/3200 [00:00&lt;00:00, 22268.19it/s]
Sanity check:  33%|███▎      | 1/3 [00:00&lt;00:00,  6.86it/s]
Sanity check Val: 100%|██████████| 300/300 [00:00&lt;00:00, 23387.01it/s]

Sanity check Test: 100%|██████████| 300/300 [00:00&lt;00:00, 23590.90it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 1604 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 200 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 200 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 1604/1604 [00:00&lt;00:00, 23877.03it/s]

Sanity check Val: 100%|██████████| 200/200 [00:00&lt;00:00, 23203.08it/s]

Sanity check Test: 100%|██████████| 200/200 [00:00&lt;00:00, 22915.31it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 804 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 100 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 100 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 804/804 [00:00&lt;00:00, 22897.44it/s]

Sanity check Val: 100%|██████████| 100/100 [00:00&lt;00:00, 21340.71it/s]

Sanity check Test: 100%|██████████| 100/100 [00:00&lt;00:00, 22097.38it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 3200 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 300 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 300 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train:   0%|          | 0/3200 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 3200/3200 [00:00&lt;00:00, 24257.19it/s]
Sanity check:  33%|███▎      | 1/3 [00:00&lt;00:00,  7.47it/s]
Sanity check Val: 100%|██████████| 300/300 [00:00&lt;00:00, 23128.65it/s]

Sanity check Test: 100%|██████████| 300/300 [00:00&lt;00:00, 23956.04it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 1604 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 200 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 200 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train:   0%|          | 0/1604 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 1604/1604 [00:00&lt;00:00, 2934.03it/s]
Sanity check:  33%|███▎      | 1/3 [00:00&lt;00:01,  1.82it/s]
Sanity check Val: 100%|██████████| 200/200 [00:00&lt;00:00, 23627.22it/s]

Sanity check Test: 100%|██████████| 200/200 [00:00&lt;00:00, 23164.63it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 804 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 100 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 100 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train:   0%|          | 0/804 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 804/804 [00:00&lt;00:00, 6946.82it/s]
Sanity check:  33%|███▎      | 1/3 [00:00&lt;00:00,  8.49it/s]
Sanity check Val: 100%|██████████| 100/100 [00:00&lt;00:00, 21575.64it/s]

Sanity check Test: 100%|██████████| 100/100 [00:00&lt;00:00, 21856.72it/s]

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Total FLOPS used for context length 128: 6.121e+13, -- [0.061 percent of budget]
Total FLOPS used for context length 512: 2.596e+14, -- [0.260 percent of budget]
Total FLOPS used for context length 768: 3.967e+14, -- [0.397 percent of budget]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><br/><br/><span></span><span class="c1"># for each</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
<span class="n">context_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#1f77b4&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff7f0e&#39;</span><span class="p">,</span> <span class="s1">&#39;#2ca02c&#39;</span><span class="p">,</span> <span class="s1">&#39;#d62728&#39;</span><span class="p">]</span>
<span class="n">examples</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Example 1&quot;</span><span class="p">,</span> <span class="s2">&quot;Example 2&quot;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">context_lengths</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">datas</span><span class="p">[</span><span class="n">context_length</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="n">full_sequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">target</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Process data for plotting</span>
        <span class="n">full_sequence_values</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">postprocess</span><span class="p">(</span><span class="n">full_sequence</span><span class="p">)</span>
        <span class="n">input_ids_values</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">postprocess</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span>

        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">decode_to_string</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">context_length</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
        <span class="c1"># Split by semicolons and process each pair</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">result_ids_values</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">semi_colon_count</span><span class="p">]</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">result_ids_values</span><span class="p">]</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">]</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">result_ids_values</span><span class="p">]</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result_ids_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1"># Apply scaling factor to get actual values</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">result_ids_values</span> <span class="o">/</span> <span class="n">processor</span><span class="o">.</span><span class="n">scaler</span>      <span class="c1"># decode the values</span>

        <span class="n">result_time</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_ids_values</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">))</span>

        <span class="c1"># Plot predator population</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">full_sequence_values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Context&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">result_time</span><span class="p">,</span> <span class="n">result_ids_values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Plot prey population</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">full_sequence_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Context&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">result_time</span><span class="p">,</span> <span class="n">result_ids_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                          <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Set titles and labels</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context Length: </span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">examples</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2"> - Predator Population&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context Length: </span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">examples</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2"> - Prey Population&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

        <span class="c1"># Add grid and legend to make the plots more readable</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Population&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

            <span class="c1"># Only show x label on bottom row</span>
            <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time Step&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Add overall title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Predator-Prey Time Series Forecasting by Context Length&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.98</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/><br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_5_initial_train_behaviour_16_0.png" src="../_images/notebooks_5_initial_train_behaviour_16_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datas</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">predicted</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">semi_colon_max</span> <span class="o">=</span> <span class="mi">20</span>
<span class="k">for</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">):</span>
    <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="n">data_master</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span>
        <span class="n">context_length</span><span class="o">=</span><span class="n">context_length</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">target_eval_pairs</span> <span class="o">=</span> <span class="n">semi_colon_max</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">temp_test_loader_active</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">test_loader</span><span class="p">)</span>
    <span class="n">datas</span><span class="p">[</span><span class="n">context_length</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="n">temp_test_loader_active</span><span class="p">)]</span>
    <span class="n">datas</span><span class="p">[</span><span class="n">context_length</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">temp_test_loader_active</span><span class="p">))</span>




<span class="n">processor</span> <span class="o">=</span> <span class="n">data_master</span><span class="o">.</span><span class="n">processor</span>

<span class="n">flops_logger</span> <span class="o">=</span> <span class="n">QwenFlopsCalculator</span><span class="p">()</span>


<span class="n">Total_flops_used</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Flops_counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">semi_colon_max</span> <span class="o">=</span> <span class="mi">200</span>


<span class="k">for</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">):</span>
    <span class="n">result</span><span class="p">[</span><span class="n">context_length</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="n">data_master</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span>
        <span class="n">context_length</span><span class="o">=</span><span class="n">context_length</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">target_eval_pairs</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="p">)</span>
    <span class="c1"># claer tqdm instance</span>
    <span class="n">tqdm</span><span class="o">.</span><span class="n">_instances</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">datas</span><span class="p">[</span><span class="n">context_length</span><span class="p">]:</span>

        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># we allow the model infer until (reached 2 * target length) or the model predict the end token (semi-colon token -&gt; 26)</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="n">semi_colon_max</span> <span class="o">*</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">original_length</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">semi_colon_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">per_step_ce</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_length</span><span class="p">):</span>

                <span class="n">flops_logger</span><span class="o">.</span><span class="n">log_flops</span><span class="p">(</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">seq_len</span><span class="o">=</span><span class="n">context_length</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">inference</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;MSE Untrained Evaluation&quot;</span><span class="p">)</span>

                <span class="c1"># only use context length size of input_ids to predict the next token</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_ids</span><span class="p">[:,</span> <span class="o">-</span><span class="n">context_length</span><span class="p">:])</span>
                <span class="n">next_token_logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">logits</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">next_token</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">next_token_logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">next_token</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># get the CE loss</span>
<span class="c1">#                 loss = torch.nn.functional.cross_entropy(next_token_logits, target[:, input_ids.shape[1] - original_length - 1])</span>
<span class="c1">#                 per_step_ce.append(loss.item())</span>

                <span class="k">if</span> <span class="n">next_token</span> <span class="o">==</span> <span class="mi">26</span><span class="p">:</span>
                    <span class="n">semi_colon_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">semi_colon_count</span> <span class="o">==</span> <span class="n">semi_colon_max</span><span class="p">:</span>
                        <span class="k">break</span>

        <span class="n">result</span><span class="p">[</span><span class="n">context_length</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_ids</span><span class="p">[:,</span> <span class="n">original_length</span><span class="p">:]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>


    <span class="n">flops_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">flops_logger</span><span class="o">.</span><span class="n">log_file</span><span class="p">)</span>
    <span class="n">current_exp_flops</span> <span class="o">=</span> <span class="n">flops_df</span><span class="p">[</span><span class="n">flops_df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">flops_logger</span><span class="o">.</span><span class="n">log_name</span><span class="p">]</span>
    <span class="n">Total_flops_used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">current_exp_flops</span><span class="o">.</span><span class="n">flops</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">Flops_counter</span>
    <span class="p">)</span>
    <span class="n">Flops_counter</span> <span class="o">=</span> <span class="n">current_exp_flops</span><span class="o">.</span><span class="n">flops</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>


<span class="c1"># print the Total_flops_used</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">flops</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Total_flops_used</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total FLOPS used for context length </span><span class="si">{</span><span class="p">[</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">512</span><span class="p">,</span><span class="w"> </span><span class="mi">768</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">flops</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">, -- [</span><span class="si">{</span><span class="n">flops</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1e17</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> percent of budget]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 3200 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 300 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 300 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train:   0%|          | 0/3200 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 3200/3200 [00:00&lt;00:00, 24046.81it/s]
Sanity check:  33%|███▎      | 1/3 [00:00&lt;00:00,  7.39it/s]
Sanity check Val: 100%|██████████| 300/300 [00:00&lt;00:00, 23297.81it/s]

Sanity check Test: 100%|██████████| 300/300 [00:00&lt;00:00, 23760.17it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 1604 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 200 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 200 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 1604/1604 [00:00&lt;00:00, 23402.36it/s]

Sanity check Val: 100%|██████████| 200/200 [00:00&lt;00:00, 23069.71it/s]

Sanity check Test: 100%|██████████| 200/200 [00:00&lt;00:00, 22683.56it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 804 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 100 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 100 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 804/804 [00:00&lt;00:00, 23054.61it/s]

Sanity check Val: 100%|██████████| 100/100 [00:00&lt;00:00, 21150.24it/s]

Sanity check Test: 100%|██████████| 100/100 [00:00&lt;00:00, 22041.64it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 3200 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 300 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 300 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train:   0%|          | 0/3200 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 3200/3200 [00:00&lt;00:00, 23988.57it/s]
Sanity check:  33%|███▎      | 1/3 [00:00&lt;00:00,  7.39it/s]
Sanity check Val: 100%|██████████| 300/300 [00:00&lt;00:00, 23050.69it/s]

Sanity check Test: 100%|██████████| 300/300 [00:00&lt;00:00, 23487.85it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 1604 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 200 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 200 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 1604/1604 [00:00&lt;00:00, 24209.55it/s]

Sanity check Val: 100%|██████████| 200/200 [00:00&lt;00:00, 22479.32it/s]

Sanity check Test: 100%|██████████| 200/200 [00:00&lt;00:00, 22976.19it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 804 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 100 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 100 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 804/804 [00:00&lt;00:00, 23197.02it/s]

Sanity check Val: 100%|██████████| 100/100 [00:00&lt;00:00, 21542.39it/s]

Sanity check Test: 100%|██████████| 100/100 [00:00&lt;00:00, 21758.07it/s]

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Total FLOPS used for context length 128: 6.291e+14, -- [0.629 percent of budget]
Total FLOPS used for context length 512: 2.656e+15, -- [2.656 percent of budget]
Total FLOPS used for context length 768: 4.116e+15, -- [4.116 percent of budget]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># save data</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;qwen_finetune_lora_result.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;qwen_finetune_lora_datas.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">datas</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

<span class="c1"># read it</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;qwen_finetune_lora_result.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;qwen_finetune_lora_datas.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">datas</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for each</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">500</span><span class="p">)</span>
<span class="n">context_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#1f77b4&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff7f0e&#39;</span><span class="p">,</span> <span class="s1">&#39;#2ca02c&#39;</span><span class="p">,</span> <span class="s1">&#39;#d62728&#39;</span><span class="p">]</span>
<span class="n">examples</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Example 1&quot;</span><span class="p">,</span> <span class="s2">&quot;Example 2&quot;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">context_lengths</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">datas</span><span class="p">[</span><span class="n">context_length</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="n">full_sequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">target</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Process data for plotting</span>
        <span class="n">full_sequence_values</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">postprocess</span><span class="p">(</span><span class="n">full_sequence</span><span class="p">)</span>
        <span class="n">input_ids_values</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">postprocess</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">decode_to_string</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">context_length</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
        <span class="c1"># Split by semicolons and process each pair</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">result_ids_values</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">semi_colon_count</span><span class="p">]</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">result_ids_values</span><span class="p">]</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">]</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">result_ids_values</span><span class="p">]</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result_ids_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1"># Apply scaling factor to get actual values</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">result_ids_values</span> <span class="o">/</span> <span class="n">processor</span><span class="o">.</span><span class="n">scaler</span>      <span class="c1"># decode the values</span>
        <span class="n">result_time</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_ids_values</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">))</span>

        <span class="c1"># Plot predator population</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Context&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">full_sequence_values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">result_time</span><span class="p">,</span> <span class="n">result_ids_values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Plot prey population</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Context&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">full_sequence_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">result_time</span><span class="p">,</span> <span class="n">result_ids_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                          <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Set titles and labels</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context Length: </span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">examples</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2"> - Predator Population&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context Length: </span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">examples</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2"> - Prey Population&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

        <span class="c1"># Add grid and legend to make the plots more readable</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Population&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

            <span class="c1"># Only show x label on bottom row</span>
            <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time Step&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Add overall title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Predator-Prey Time Series Forecasting by Context Length&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.98</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/><br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_5_initial_train_behaviour_19_0.png" src="../_images/notebooks_5_initial_train_behaviour_19_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for each</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span>
<span class="n">context_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#1f77b4&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff7f0e&#39;</span><span class="p">,</span> <span class="s1">&#39;#2ca02c&#39;</span><span class="p">,</span> <span class="s1">&#39;#d62728&#39;</span><span class="p">]</span>
<span class="n">examples</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Example 1&quot;</span><span class="p">,</span> <span class="s2">&quot;Example 2&quot;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">context_lengths</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">datas</span><span class="p">[</span><span class="n">context_length</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="n">full_sequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">target</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Process data for plotting</span>
        <span class="n">full_sequence_values</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">postprocess</span><span class="p">(</span><span class="n">full_sequence</span><span class="p">)</span>
        <span class="n">input_ids_values</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">postprocess</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">decode_to_string</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">context_length</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
        <span class="c1"># Split by semicolons and process each pair</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">result_ids_values</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">semi_colon_count</span><span class="p">]</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">result_ids_values</span><span class="p">]</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">]</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">result_ids_values</span><span class="p">]</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result_ids_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1"># Apply scaling factor to get actual values</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">result_ids_values</span> <span class="o">/</span> <span class="n">processor</span><span class="o">.</span><span class="n">scaler</span>      <span class="c1"># decode the values</span>
        <span class="n">result_time</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_ids_values</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">))</span>

        <span class="c1"># Plot predator population</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Context&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">full_sequence_values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">result_time</span><span class="p">,</span> <span class="n">result_ids_values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Plot prey population</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Context&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">full_sequence_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">result_time</span><span class="p">,</span> <span class="n">result_ids_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                          <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Set titles and labels</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context Length: </span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">examples</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2"> - Predator Population&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context Length: </span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">examples</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2"> - Prey Population&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

        <span class="c1"># Add grid and legend to make the plots more readable</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Population&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

            <span class="c1"># Only show x label on bottom row</span>
            <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time Step&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Add overall title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Predator-Prey Time Series Forecasting by Context Length&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.98</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/><br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_5_initial_train_behaviour_20_0.png" src="../_images/notebooks_5_initial_train_behaviour_20_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prompt_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;How many r in strawberry?&quot;</span><span class="p">,</span>
    <span class="s2">&quot;what is the result of 1 + 1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;what is the result of 0.12 + 3.24&quot;</span><span class="p">,</span>
    <span class="s2">&quot;0, 1, 1, 2, 3, 5, 8,&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Write a poem that uses numbers as metaphors. For instance, start with &#39;1.20, 1.31; 0.93, 0.98&#39; and explore what these figures might mean in life.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Craft a poem that tells a story of dreams and memories, using punctuation naturally to evoke a rhythmic, lyrical quality.&quot;</span>

<span class="p">]</span>

<span class="k">for</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="n">prompt_list</span><span class="p">:</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;You are Qwen, created by Alibaba Cloud. You are a helpful assistant.&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}</span>
    <span class="p">]</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
        <span class="n">messages</span><span class="p">,</span>
        <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">add_generation_prompt</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">model_inputs</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">([</span><span class="n">text</span><span class="p">],</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="n">generated_ids</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
        <span class="o">**</span><span class="n">model_inputs</span><span class="p">,</span>
        <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">512</span>
    <span class="p">)</span>
    <span class="n">generated_ids</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">output_ids</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">input_ids</span><span class="p">):]</span> <span class="k">for</span> <span class="n">input_ids</span><span class="p">,</span> <span class="n">output_ids</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">model_inputs</span><span class="o">.</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">generated_ids</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">generated_ids</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">=========================</span>
<span class="s2">Question: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span>
<span class="s2">---</span>
<span class="s2">Response: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span>
<span class="s2">=========================</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

=========================
Question: How many r in strawberry?
---
Response: In the Chinese language, &#34;strawberry&#34; is pronounced as &#34;sāo bāng&#34;, which means &#34;red strawberry&#34;. The number &#34;r&#34; at the end of the word refers to the pronunciation of the final consonant sound.

So, if we were to count the number of syllables (or &#39;r&#39;s) in &#34;strawberry&#34;, it would be 2. This is because each syllable begins with one or more vowels and ends with one or more consonants.
=========================


=========================
Question: what is the result of 1 + 1
---
Response: The result of adding 1 and 1 is 2.
=========================


=========================
Question: what is the result of 0.12 + 3.24
---
Response: The result of \(0.12 + 3.24\) is:

\(3.36\)

This calculation involves adding two numbers together. Here&#39;s how you do it step-by-step:

1. Align the decimal points:
   \[
   \begin{array}{r}
     0.12 \\
+ 3.24 \\
\hline
   \end{array}
   \]

2. Add the digits in the tenths place (leftmost column):
   - \(0 + 4 = 4\)
   Write down 4 in the tenths place.

3. Add the digits in the hundredths place (second column to the right):
   - \(1 + 2 = 3\)
   Write down 3 in the hundredths place.

4. Add the digits in the thousandths place (third column to the right):
   - \(0 + 4 = 4\)
   Write down 4 in the thousandths place.

Combining all these results, we get:
\[ 0.12 + 3.24 = 3.36 \]
=========================


=========================
Question: 0, 1, 1, 2, 3, 5, 8,
---
Response: The sequence you&#39;ve provided is the Fibonacci sequence, which starts with two one-digit numbers (0 and 1), and each subsequent number is the sum of the previous two:

- 0 + 1 = 1
- 1 + 1 = 2
- 1 + 2 = 3
- 2 + 3 = 5
- 3 + 5 = 8
- 5 + 8 = 13

So the first few terms of this sequence are:
0, 1, 1, 2, 3, 5, 8, ...

And it continues in that pattern indefinitely.
=========================


=========================
Question: Write a poem that uses numbers as metaphors. For instance, start with &#39;1.20, 1.31; 0.93, 0.98&#39; and explore what these figures might mean in life.
---
Response: Verse 1:
In the realm of numbers, where one is measured,
One can see how they hold weight, and their worth.
Numbers like &#39;1.20, 1.31&#39;, tell us of growth,
Their power to shape our lives, so grand.

Verse 2:
Yet, we must remember, there&#39;s more than just numbers,
Each number tells a story, not just for its own sake.
So let&#39;s not shy away from the vastness,
Of the world we live in, and all its mysteries.

Verse 3:
From small beginnings, to great achievements,
Numbers help us chart our way forward.
They guide us through the maze, with clarity,
And show us paths that lead to success.

Verse 4:
But it&#39;s not all about the numbers, but also about understanding them,
Understanding the context, why they were chosen.
For each number has a story behind it,
A tale that shapes who we become, and why.

Verse 5:
Let&#39;s embrace this metaphor, and use it wisely,
To understand ourselves, and to make sense.
For in the world of numbers, we&#39;re never alone,
As we navigate through life&#39;s many challenges.
=========================


=========================
Question: Craft a poem that tells a story of dreams and memories, using punctuation naturally to evoke a rhythmic, lyrical quality.
---
Response: In the quiet of dawn&#39;s first light,
Where whispers of old tales begin to flow,
A dream, a memory, a thread so fine,
Tied to every step, each secret.

The world around us shifts, a kaleidoscope,
Each shadow a new chapter, a new story.
In this moment, time stands still,
As memories dance, in harmony with the breeze.

We wander through life&#39;s vast expanse,
Dreams编织着我们的未来，
每一颗星，每一缕光，
都是我们灵魂的诗篇。

在这片无垠的天地间，
我们寻找那遥远的梦想，
在梦中寻觅，直到梦醒。
这是一场漫长的旅程，
而每一次呼吸，都承载着记忆。
=========================

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prompt_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;How many r in strawberry?&quot;</span><span class="p">,</span>
    <span class="s2">&quot;what is the result of 1 + 1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;what is the result of 0.12 + 3.24&quot;</span><span class="p">,</span>
    <span class="s2">&quot;0, 1, 1, 2, 3, 5, 8,&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Write a poem that uses numbers as metaphors. For instance, start with &#39;1.20, 1.31; 0.93, 0.98&#39; and explore what these figures might mean in life.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Craft a poem that tells a story of dreams and memories, using punctuation naturally to evoke a rhythmic, lyrical quality.&quot;</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="n">prompt_list</span><span class="p">:</span>
    <span class="c1"># Tokenize the prompt directly</span>
    <span class="n">model_inputs</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">([</span><span class="n">prompt</span><span class="p">],</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># Generate text</span>
    <span class="n">generated_ids</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
        <span class="o">**</span><span class="n">model_inputs</span><span class="p">,</span>
        <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">512</span>
    <span class="p">)</span>

    <span class="c1"># Extract only the newly generated tokens</span>
    <span class="n">generated_ids</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">output_ids</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">input_ids</span><span class="p">):]</span> <span class="k">for</span> <span class="n">input_ids</span><span class="p">,</span> <span class="n">output_ids</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">model_inputs</span><span class="o">.</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">generated_ids</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Decode the generated tokens</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">generated_ids</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">=========================</span>
<span class="s2">Prompt: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span>
<span class="s2">---</span>
<span class="s2">Response: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span>
<span class="s2">=========================</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

=========================
Prompt: How many r in strawberry?
---
Response:  - Answers\nMath and Arithmetic\nGeography\nWhat number of r&#39;s are there in strawberry?\nWiki User\n∙ 2015-07-26 13:28:49\nSee Answer\nBest Answer\nCopy\nThere is one r in a strawberry. A strawberry has two r&#39;s.\nWiki User\n∙ 2015-07-26 13:28:49\nThis answer is:\nHelpful\nNot Helpful\n0\nExplanation:\nThe word \&#34;r\&#34; is used to describe the stem of the flower,\nbecause it appears on the outside of the flower. The flower has\nseveral different types, with the largest being the red\nstrawberry (Rosa canina). The other types have smaller\nflowers called &#39;carnations&#39;. The r is not part of the fruit,\nit&#39;s just how we see it when we look at a strawberry.\nAnswered by\nKathryn K\nTop Q&amp;A Starters\nRelated questions\nHow many r&#39;s are there in strawberries?\nAsked By\nWiki User\nHow many r&#39;s are there in strawberries?\nAsked By\nSamantha Ruffin\nHow many r&#39;s are there in a strawberry?\nAsked By\nTrevor Smith\nHow many r&#39;s are there in strawberry?\nAsked By\nJared Johnson\nHow many r&#39;s are there in strawberry?\nAsked By\nTrevor Smith\nHow many r&#39;s are there in strawberry?\nAsked By\nTrevor Smith\nHow many r&#39;s are there in strawberries?\nAsked By\nTrevor Smith\nPeople also asked\nHow many r&#39;s are there in strawberry?\nWhen did strawberry become popular?\nHow do you find out what type of strawberry is it?\nHow many r&#39;s are in a strawberry?
=========================


=========================
Prompt: what is the result of 1 + 1
---
Response: /2 + 1/4 + 1/8 + 1/16?

To find the result of \(1 + \frac{1}{2} + \frac{1}{4} + \frac{1}{8} + \frac{1}{16}\), we can use a common method to add these fractions. The key idea here is to express each term with a denominator that is a power of 2.

First, let&#39;s rewrite each term with a denominator of 32 (which is \(2^5\)):

\[1 = \frac{32}{32}, \quad \frac{1}{2} = \frac{16}{32}, \quad \frac{1}{4} = \frac{8}{32}, \quad \frac{1}{8} = \frac{4}{32}, \quad \frac{1}{16} = \frac{2}{32}\]

Now, we can add them together:

\[\frac{32}{32} + \frac{16}{32} + \frac{8}{32} + \frac{4}{32} + \frac{2}{32} = \frac{32 + 16 + 8 + 4 + 2}{32} = \frac{62}{32}\]

Next, we simplify \(\frac{62}{32}\) by dividing both the numerator and the denominator by their greatest common divisor, which is 2:

\[\frac{62 \div 2}{32 \div 2} = \frac{31}{16}\]

Therefore, the result of \(1 + \frac{1}{2} + \frac{1}{4} + \frac{1}{8} + \frac{1}{16}\) is \(\boxed{\frac{31}{16}}\).
=========================


=========================
Prompt: what is the result of 0.12 + 3.24
---
Response: ? To find the sum of 0.12 and 3.24, you simply add them together:

0.12 + 3.24 = 3.36

So, the result of 0.12 + 3.24 is 3.36.
=========================


=========================
Prompt: 0, 1, 1, 2, 3, 5, 8,
---
Response:  13, 21, 37, 61, 98, 159, 258, 418, 676, 1095, 1794, 2865, 4634, 7503, 12132, 20087, 33208, 55291, 91579, 166870, 268457, 445332, 770243, 1275676, 2145925, 3421573, 5587592, 9079171, 15266742, 24345913, 39512656, 63878571, 103391228, 170290265, 273680504, 443970763, 714651068, 1158321771, 1972972840, 3122903631, 5191205411, 8314108842, 13527314253, 21841423095, 35368737348, 57120160743, 92488897091, 149608997834, 241190157925, 391799155757, 633999153682, 1025808279440, 1659807433122, 2685727999782, 43455353
=========================


=========================
Prompt: Write a poem that uses numbers as metaphors. For instance, start with &#39;1.20, 1.31; 0.93, 0.98&#39; and explore what these figures might mean in life.
---
Response:  Use imagery to describe the magnitude of each number, and how they relate to one another in a meaningful way.

In a world where numbers dance,
Numbers twirl like stars in the night sky.
1.20, 1.31—numbers dancing so high,
A never-ending journey through time.

They whisper secrets to us all,
And in their light we find our place.
0.93, 0.98—numbers moving together,
Their sum is like a river flowing on.

Together, they create a pattern,
A symphony of numbers, unending.
1.20, 1.31, 0.93, 0.98—like a family tree,
Each member holding their own part in this grand plan.

The numbers are not just numbers,
But stories woven into a tapestry.
From the first coin tossed to the last,
These figures tell a story of purpose.

In this universe where numbers dance,
We find our meaning, and our purpose too.
Together, numbers form a perfect chain,
That links every being, every moment.

So let them guide us through life&#39;s maze,
With love, hope, and a sense of wonder.
For in the vast expanse of numbers,
There lies a message for all to hear.

I hope you found my poem interesting. Do you have any other ideas or poems I could consider? Perhaps something more personal or about nature?

Absolutely! Here’s a poem inspired by nature:

Nature&#39;s Symphony
Of Numbers in Motion

1.50, 1.61—The wind whispers through the trees,
A gentle, soothing melody.
0.74, 0.78—A gentle breeze carries us far,
Through fields of vibrant flowers.

2.00, 2.12—The sun sets bright, casting shadows,
Nature&#39;s canvas, painted with hues of gold.
0.86, 0.92—Sunlight filters through leaves,
Creating a beautiful, serene scene.

1.00, 1.12—The leaves rustle gently,
As butterflies flit from flower to flower.
0.99, 0.95—The soft hum of birdsong,
Is a symphony of peace and joy.

1.20, 1.31—The air is crisp, cool and clean,
Nature&#39;s breath, pure and fresh.
0.93, 0.98—The forest canopy holds its shape,
Reflecting the
=========================


=========================
Prompt: Craft a poem that tells a story of dreams and memories, using punctuation naturally to evoke a rhythmic, lyrical quality.
---
Response:  The poem should end with an image or sound that captures the essence of the dream or memory in vivid detail.

In a realm where whispers meet the night,
A tale unfolds, a dream weaves.
From the depths of the mind&#39;s embrace,
To the echoes of a distant past.

A sea of clouds drifts like silver threads,
A sky painted by stars so bright.
A river flows, its waters cold,
A world where shadows dance.

The sun rises, casting golden light,
And dreams begin to grow anew.
A heart beats fast, a soul finds strength,
As memories gather, as words are said.

The wind whispers secrets, through leaves so green,
A melody that lingers, a song untold.
A smile spreads, a tear falls,
As memories of love, laughter, pain.

Through the pages of time, they&#39;re bound,
To this moment, where all is new.
For in their wake, a new life is born,
A legacy that never fades.

So let us cherish these dreams and memories,
For they hold the keys to our hearts.
For in them lies the power to change,
Our lives forever, beyond compare.

And as the moon casts its silver glow,
Let us look up, and find the way.
For in the depths of our hearts,
We have the power to make it all true.

(End of Poem)

P.S. If you enjoyed this poem, consider sharing it with someone who appreciates it. It will help spread the word about poetry! 📖✨

---

**Pronunciation:**
- Ah-yoo-mah-reee ah-rah-reee nee-uh-gon &#34;ah-REE-may&#34; ah-reen &#34;eh-noo&#34; gee-oh-nee ehe-huh &#34;ee-neh-gun&#34;

This poem aims to capture the essence of dreams and memories through vivid imagery and language, evoking a sense of enchantment and wonder. The rhythm is naturalistic, allowing for a lyrical flow without losing the poetic elements. The final line invites readers to imagine themselves being part of the dream narrative, making it both relatable and inspiring.
=========================

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="4_train_lora_llm.html" class="btn btn-neutral float-left" title="Train LoRA-LLM" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="6_fully_trained_behaviour.html" class="btn btn-neutral float-right" title="Evaluating Fully Trained LLM Performance on Time Series Forecasting" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Yuchen Mao.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>