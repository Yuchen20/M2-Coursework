

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Evaluating Fully Trained LLM Performance on Time Series Forecasting &mdash; Time Series Forecasting with LLMs beta documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=d2d258e8" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=a6e103b4" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=f0d2c090"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="LM Bias Weight Visualization" href="7_weight_visualize.html" />
    <link rel="prev" title="Evaluating Trained LLM Performance on Time Series Forecasting" href="5_initial_train_behaviour.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Time Series Forecasting with LLMs
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Jupyter Notebooks</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="1_dataset_preprocess.html">Lotka-Volterra Dataset Exploration &amp; LLMTIME Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="2_flops_calculation.html">Understanding FLOPS Calculation for Qwen2.5 Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="3_untrained_behaviour.html">Evaluating Untrained LLM Performance on Time Series Forecasting</a></li>
<li class="toctree-l1"><a class="reference internal" href="4_train_lora_llm.html">Train LoRA-LLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="5_initial_train_behaviour.html">Evaluating Trained LLM Performance on Time Series Forecasting</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Evaluating Fully Trained LLM Performance on Time Series Forecasting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Data-Preparation">Data Preparation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Zero-Shot-Forecasting-Evaluation">Zero-Shot Forecasting Evaluation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#Flops-Analysis">Flops Analysis</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Results-Analysis">Results Analysis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="7_weight_visualize.html">LM Bias Weight Visualization</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Time Series Forecasting with LLMs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Evaluating Fully Trained LLM Performance on Time Series Forecasting</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks/6_fully_trained_behaviour.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="admonition note">
<p class="admonition-title">Note</p>
<p>This page was generated from a Jupyter notebook.
<a class="reference external" href="https://github.com/yourusername/time_series_llm/blob/main/notebooks6_fully_trained_behaviour.ipynb">View the original notebook</a></p>
</div>
<section id="Evaluating-Fully-Trained-LLM-Performance-on-Time-Series-Forecasting">
<h1>Evaluating Fully Trained LLM Performance on Time Series Forecasting<a class="headerlink" href="#Evaluating-Fully-Trained-LLM-Performance-on-Time-Series-Forecasting" title="Link to this heading"></a></h1>
<p>This notebook examines the fully trained performance of the Qwen2.5-0.5B-Instruct model on predator-prey time series forecasting. The overall structure of this notebook is a direct copy of the <code class="docutils literal notranslate"><span class="pre">notebooks\3_untrained_behaviour.ipynb</span></code> script, with the exception of loading in the weights of <strong>LoRA</strong> into the model. The model is evaluated on the same time series forecasting tasks as in the original notebook.</p>
<p>In the cell below, we have loaded the weights of the <strong>LoRA</strong> model into the Qwen2.5-0.5B-Instruct model using the <code class="docutils literal notranslate"><span class="pre">load_checkpoint</span></code> function. This function loads the weights from the specified checkpoint file into the model.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoModelForCausalLM</span><span class="p">,</span> <span class="n">AutoTokenizer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__name__</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span> <span class="s1">&#39;src&#39;</span><span class="p">)))</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">get_flops</span><span class="w"> </span><span class="kn">import</span> <span class="n">QwenFlopsCalculator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">get_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">LotkaVolterraDataset</span><span class="p">,</span> <span class="n">DataMaster</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">preprocessor</span><span class="w"> </span><span class="kn">import</span> <span class="n">NumericalProcessor</span>


<span class="k">class</span><span class="w"> </span><span class="nc">LoRALinear</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LoRA implementation for linear layers.</span>
<span class="sd">    Adds low-rank adaptation matrices to an existing linear layer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_linear</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">original_linear</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_linear</span> <span class="o">=</span> <span class="n">original_linear</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_linear</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_linear</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">original_linear</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">in_dim</span> <span class="o">=</span> <span class="n">original_linear</span><span class="o">.</span><span class="n">in_features</span>
        <span class="n">out_dim</span> <span class="o">=</span> <span class="n">original_linear</span><span class="o">.</span><span class="n">out_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span> <span class="k">if</span> <span class="n">alpha</span> <span class="k">else</span> <span class="n">r</span>

        <span class="n">device</span> <span class="o">=</span> <span class="n">original_linear</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">in_dim</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">out_dim</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>

        <span class="c1"># Initialise A with He initialization</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">kaiming_normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">nonlinearity</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">merged_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_linear</span><span class="o">.</span><span class="n">weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_merged</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_merged</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">merged_weight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_linear</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>

        <span class="n">base_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_linear</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">lora_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">base_out</span> <span class="o">+</span> <span class="n">lora_out</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merged_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_linear</span><span class="o">.</span><span class="n">weight</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_merged</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">unmerge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_merged</span> <span class="o">=</span> <span class="kc">False</span>


<span class="c1"># models</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_qwen</span><span class="p">():</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;Qwen/Qwen2.5-0.5B-Instruct&quot;</span>
    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Freeze all parameters except LM head bias</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
        <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Add trainable bias to logits</span>
    <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">lm_head</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="n">model</span><span class="o">.</span><span class="n">lm_head</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">lm_head</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span>

<span class="k">def</span><span class="w"> </span><span class="nf">apply_lora</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lora_rank</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply LoRA to specific layers in the model.&quot;&quot;&quot;</span>
    <span class="c1"># Re-freeze all model parameters to be sure</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
        <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Apply LoRA to query and value projection layers</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">self_attn</span><span class="o">.</span><span class="n">q_proj</span> <span class="o">=</span> <span class="n">LoRALinear</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">self_attn</span><span class="o">.</span><span class="n">q_proj</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">lora_rank</span><span class="p">)</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">self_attn</span><span class="o">.</span><span class="n">v_proj</span> <span class="o">=</span> <span class="n">LoRALinear</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">self_attn</span><span class="o">.</span><span class="n">v_proj</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">lora_rank</span><span class="p">)</span>

    <span class="c1"># Make sure the LM head bias remains trainable</span>
    <span class="n">model</span><span class="o">.</span><span class="n">lm_head</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">model</span>

<span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">load_qwen</span><span class="p">()</span>

<span class="c1"># Fixed hyperparameters as specified</span>
<span class="n">context_length</span> <span class="o">=</span> <span class="mi">768</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">max_steps</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">eval_interval</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">target_eval_pairs</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">experiment_fraction</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">test_size</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">val_size</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="n">lora_rank</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">max_budget</span> <span class="o">=</span> <span class="mi">40</span>



<span class="n">model</span> <span class="o">=</span> <span class="n">apply_lora</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lora_rank</span><span class="p">)</span>


<span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;../checkpoint/checkpoint_final.pth&#39;</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">weights_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">load_checkpoint</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a model checkpoint.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load model weights</span>
        <span class="n">model_state_dict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">model_state_dict</span><span class="p">:</span>
                <span class="n">model_state_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">model_state_dict</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded checkpoint successfully&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while applying checkpoint: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Continuing with original model without loading checkpoint.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span>

<span class="c1"># Apply the checkpoint to the model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">)</span>

<span class="c1"># some nice function for GPU Training</span>
<span class="k">def</span><span class="w"> </span><span class="nf">clear_memory</span><span class="p">():</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">):</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">ipc_collect</span><span class="p">()</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">reset_peak_memory_stats</span><span class="p">()</span>

<span class="c1"># device</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

<span class="c1"># random seed</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sliding Window Attention is enabled but not implemented for `sdpa`; unexpected results may be encountered.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Loaded checkpoint successfully
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">self_attn</span><span class="o">.</span><span class="n">q_proj</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Parameter containing:
tensor([[ 0.0809,  0.0361,  0.0053,  ..., -0.0371, -0.0772, -0.0441],
        [-0.0458,  0.0060,  0.0412,  ...,  0.0524,  0.0330,  0.0265],
        [ 0.0244,  0.0426, -0.0172,  ..., -0.0347,  0.0223, -0.0157],
        ...,
        [ 0.0524, -0.0127, -0.0973,  ..., -0.0705, -0.0334, -0.0127],
        [-0.0402, -0.0198,  0.0417,  ...,  0.0111, -0.0025,  0.0208],
        [-0.0079, -0.0428,  0.0051,  ...,  0.0143,  0.0452, -0.0035]],
       device=&#39;cuda:0&#39;, requires_grad=True)
</pre></div></div>
</div>
<section id="Data-Preparation">
<h2>Data Preparation<a class="headerlink" href="#Data-Preparation" title="Link to this heading"></a></h2>
<p>For efficient experimentation, we use the <code class="docutils literal notranslate"><span class="pre">DataMaster</span></code> class which handles:</p>
<ul class="simple">
<li><p>Loading the Lotka-Volterra predator-prey time series data</p></li>
<li><p>Preprocessing numerical data using the LLMTIME scheme</p></li>
<li><p>Creating appropriate train/validation/test splits</p></li>
<li><p>Building PyTorch DataLoaders with configurable parameters</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">experiment_fraction=0.1</span></code> parameter allows us to work with a smaller subset of data (10%) for faster iteration during development. In our final evaluation, we can scale this up to use the complete dataset by setting it to 1.0.</p>
<p>The context length parameter controls how much historical data the model sees when making predictions. Varying this parameter helps us understand the model’s sensitivity to context window size, which is important for both performance optimization and FLOPS budget management.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %%</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="c1"># Load the data</span>


<span class="c1"># data folder:</span>
<span class="n">DATA_FOLDER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__name__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>


<span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_FOLDER</span><span class="p">,</span> <span class="s1">&#39;lotka_volterra_data.h5&#39;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="c1"># Access the full dataset</span>
    <span class="n">trajectories</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;trajectories&quot;</span><span class="p">][:]</span>
    <span class="n">time_points</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][:]</span>

<span class="c1"># Here we are only using a small fraction of the data for the experiment</span>
<span class="n">data_master</span> <span class="o">=</span> <span class="n">DataMaster</span><span class="p">(</span>
    <span class="n">tokenizer</span><span class="p">,</span> <span class="n">trajectories</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">val_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">experiment_fraction</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Zero-Shot-Forecasting-Evaluation">
<h2>Zero-Shot Forecasting Evaluation<a class="headerlink" href="#Zero-Shot-Forecasting-Evaluation" title="Link to this heading"></a></h2>
<p>Now we evaluate the untrained Qwen2.5-0.5B model on predator-prey time series forecasting. The evaluation procedure:</p>
<ol class="arabic simple">
<li><p><strong>Sequential Prediction</strong>: We provide the model with initial context (e.g., 128 tokens) and let it autoregressively generate predictions</p></li>
<li><p><strong>Termination Criteria</strong>: The model generates tokens until either:</p>
<ul class="simple">
<li><p>It produces a maximum of <code class="docutils literal notranslate"><span class="pre">semi_colon_max</span></code> semicolons (<strong>indicating how many complete timestamps of (predator, prey) pairs we want to forecast</strong>)</p></li>
</ul>
</li>
<li><p><strong>Metric Calculation</strong>: We decode the generated tokens back to numerical values and compute:</p>
<ul class="simple">
<li><p>Mean Squared Error (MSE): Measures average squared difference between predictions and ground truth</p></li>
<li><p>Mean Absolute Error (MAE): Measures average absolute difference</p></li>
<li><p>Time-indexed metrics: Track how errors evolve over sequential prediction steps</p></li>
</ul>
</li>
</ol>
<p>We evaluate across multiple context window sizes (128, 512, 768) to understand how the amount of historical context affects forecasting accuracy. This gives us insights into the model’s inherent temporal reasoning capabilities and memory limitations.</p>
<p>All FLOPS usage is carefully tracked to ensure we stay within our computational budget of 10^17 FLOPS.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %%</span>

<span class="n">processor</span> <span class="o">=</span> <span class="n">data_master</span><span class="o">.</span><span class="n">processor</span>

<span class="n">flops_logger</span> <span class="o">=</span> <span class="n">QwenFlopsCalculator</span><span class="p">()</span>


<span class="n">Total_flops_used</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Flops_counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>


<span class="n">logged_metrics</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">):</span>
    <span class="n">semi_colon_max</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MSE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MAE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MSE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">_per_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MAE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">_per_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;CE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">_per_token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>


    <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="n">data_master</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span>
        <span class="n">context_length</span><span class="o">=</span><span class="n">context_length</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">target_eval_pairs</span> <span class="o">=</span> <span class="n">semi_colon_max</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="p">)</span>

    <span class="n">loader</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">test_loader</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">loader</span><span class="p">:</span>

        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># we allow the model infer until (reached 2 * target length) or the model predict the end token (semi-colon token -&gt; 26)</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="n">semi_colon_max</span> <span class="o">*</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">original_length</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">semi_colon_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">per_step_ce</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_length</span><span class="p">):</span>

                <span class="n">flops_logger</span><span class="o">.</span><span class="n">log_flops</span><span class="p">(</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">seq_len</span><span class="o">=</span><span class="n">context_length</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">inference</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;MSE Untrained Evaluation&quot;</span><span class="p">)</span>

                <span class="c1"># only use context length size of input_ids to predict the next token</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_ids</span><span class="p">[:,</span> <span class="o">-</span><span class="n">context_length</span><span class="p">:])</span>
                <span class="n">next_token_logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">logits</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">next_token</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">next_token_logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">next_token</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># get the CE loss</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">next_token_logits</span><span class="p">,</span> <span class="n">target</span><span class="p">[:,</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">original_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">per_step_ce</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

                <span class="k">if</span> <span class="n">next_token</span> <span class="o">==</span> <span class="mi">26</span><span class="p">:</span>
                    <span class="n">semi_colon_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">semi_colon_count</span> <span class="o">==</span> <span class="n">semi_colon_max</span><span class="p">:</span>
                        <span class="k">break</span>

        <span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;CE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">_per_token&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">per_step_ce</span><span class="p">)</span>


        <span class="c1"># convert to numpy</span>
        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="c1"># postprocess</span>
        <span class="n">predicted_values</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">decode_to_string</span><span class="p">(</span><span class="n">input_ids</span><span class="p">[</span><span class="n">original_length</span><span class="p">:])</span>
        <span class="n">target_values</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">decode_to_string</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="c1"># for both get the first semi-colon and use any value after that</span>
        <span class="n">predicted_values</span> <span class="o">=</span> <span class="n">predicted_values</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">semi_colon_count</span><span class="p">]</span>
        <span class="n">predicted_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">pred_val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">pred_val</span> <span class="ow">in</span> <span class="n">predicted_values</span><span class="p">]</span>
        <span class="n">predicted_values</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">pred_val</span><span class="p">]</span> <span class="k">for</span> <span class="n">pred_val</span> <span class="ow">in</span> <span class="n">predicted_values</span><span class="p">]</span>
        <span class="n">predicted_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">predicted_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">predicted_values</span> <span class="o">=</span> <span class="n">predicted_values</span> <span class="o">/</span> <span class="n">processor</span><span class="o">.</span><span class="n">scaler</span>

        <span class="n">target_values</span> <span class="o">=</span> <span class="n">target_values</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">semi_colon_count</span><span class="p">]</span>
        <span class="n">target_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">tar_val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">tar_val</span> <span class="ow">in</span> <span class="n">target_values</span><span class="p">]</span>
        <span class="n">target_values</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">tar_val</span><span class="p">]</span> <span class="k">for</span> <span class="n">tar_val</span> <span class="ow">in</span> <span class="n">target_values</span><span class="p">]</span>
        <span class="n">target_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">target_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">target_values</span> <span class="o">=</span> <span class="n">target_values</span> <span class="o">/</span> <span class="n">processor</span><span class="o">.</span><span class="n">scaler</span>


        <span class="n">mse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">predicted_values</span> <span class="o">-</span> <span class="n">target_values</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">predicted_values</span> <span class="o">-</span> <span class="n">target_values</span><span class="p">))</span>

        <span class="n">mse_per_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">predicted_values</span> <span class="o">-</span> <span class="n">target_values</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mae_per_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">predicted_values</span> <span class="o">-</span> <span class="n">target_values</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MSE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">_per_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mse_per_time</span><span class="p">)</span>
        <span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MAE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">_per_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mae_per_time</span><span class="p">)</span>

        <span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MSE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mse</span><span class="p">)</span>
        <span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MAE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mae</span><span class="p">)</span>

        <span class="n">loader</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;MSE: </span><span class="si">{</span><span class="n">mse</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, MAE: </span><span class="si">{</span><span class="n">mae</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>



    <span class="n">flops_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">flops_logger</span><span class="o">.</span><span class="n">log_file</span><span class="p">)</span>
    <span class="n">current_exp_flops</span> <span class="o">=</span> <span class="n">flops_df</span><span class="p">[</span><span class="n">flops_df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">flops_logger</span><span class="o">.</span><span class="n">log_name</span><span class="p">]</span>
    <span class="n">Total_flops_used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">current_exp_flops</span><span class="o">.</span><span class="n">flops</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">Flops_counter</span>
    <span class="p">)</span>
    <span class="n">Flops_counter</span> <span class="o">=</span> <span class="n">current_exp_flops</span><span class="o">.</span><span class="n">flops</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>


<span class="c1"># pad the perstep CE to the same length</span>
<span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;CE_128_per_token&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">logged_metrics</span><span class="p">:</span>
    <span class="k">if</span> <span class="s1">&#39;CE&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
            <span class="n">logged_metrics</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>


<span class="c1"># print the Total_flops_used</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">flops</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Total_flops_used</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total FLOPS used for context length </span><span class="si">{</span><span class="p">[</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">512</span><span class="p">,</span><span class="w"> </span><span class="mi">768</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">flops</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">, -- [</span><span class="si">{</span><span class="n">flops</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1e17</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> percent of budget]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 3200 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 400 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 400 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train:   0%|          | 0/3200 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 3200/3200 [00:00&lt;00:00, 23624.31it/s]
Sanity check:  33%|███▎      | 1/3 [00:00&lt;00:00,  7.29it/s]
Sanity check Val: 100%|██████████| 400/400 [00:00&lt;00:00, 24111.43it/s]

Sanity check Test: 100%|██████████| 400/400 [00:00&lt;00:00, 24266.98it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 1604 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 200 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 200 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 1604/1604 [00:00&lt;00:00, 23080.65it/s]

Sanity check Val: 100%|██████████| 200/200 [00:00&lt;00:00, 22344.60it/s]

Sanity check Test: 100%|██████████| 200/200 [00:00&lt;00:00, 22419.84it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 804 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 100 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 100 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 804/804 [00:00&lt;00:00, 23158.63it/s]

Sanity check Val: 100%|██████████| 100/100 [00:00&lt;00:00, 21503.74it/s]

Sanity check Test: 100%|██████████| 100/100 [00:00&lt;00:00, 22092.73it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Total FLOPS used for context length 128: 3.501e+15, -- [3.501 percent of budget]
Total FLOPS used for context length 512: 7.325e+15, -- [7.325 percent of budget]
Total FLOPS used for context length 768: 5.384e+15, -- [5.384 percent of budget]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<p>Now, we can show the results of the evaluation. We will display the MSE and MAE for each context window size, as well as the time-indexed metrics to understand how the model’s forecasting performance degrades over time.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context Length: </span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># print(f&#39;CE per token: {np.mean(logged_metrics[f&quot;CE_{context_length}_per_token&quot;])}&#39;)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MSE: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;MSE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s2">_per_time&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">, MAE: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;MAE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s2">_per_time&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MSE per time: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;MSE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s2">_per_time&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MAE per time: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;MAE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s2">_per_time&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">()</span>


<span class="c1"># Plot 1: MSE and MAE degradation over time for each context length</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">context_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">]</span>
<span class="n">time_steps</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># 0 to 4 time steps</span>

<span class="c1"># Plot MSE degradation over time</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">context_lengths</span><span class="p">):</span>
    <span class="n">mse_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MSE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">_per_time&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span> <span class="n">mse_values</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Context Length </span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;MSE Degradation Over Time&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time Step&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Squared Error&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Plot MAE degradation over time</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">context_lengths</span><span class="p">):</span>
    <span class="n">mae_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MAE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">_per_time&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span> <span class="n">mae_values</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Context Length </span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;MAE Degradation Over Time&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time Step&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Absolute Error&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Plot 2: MSE and MAE vs context length</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">mse_by_context</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MSE_</span><span class="si">{</span><span class="n">cl</span><span class="si">}</span><span class="s1">_per_time&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">context_lengths</span><span class="p">]</span>
<span class="n">mae_by_context</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MAE_</span><span class="si">{</span><span class="n">cl</span><span class="si">}</span><span class="s1">_per_time&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">context_lengths</span><span class="p">]</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">context_lengths</span><span class="p">,</span> <span class="n">mse_by_context</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MSE&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">context_lengths</span><span class="p">,</span> <span class="n">mae_by_context</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MAE&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Error Metrics by Context Length&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Context Length&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Error Value&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">context_lengths</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/><br/><br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
==================================================
Context Length: 128
MSE: 0.026321, MAE: 0.072551
MSE per time: [0.00195198 0.00587416 0.01629537 0.03801932 0.06946652]
MAE per time: [0.02033901 0.04019548 0.06644831 0.0996622  0.13611017]

==================================================
Context Length: 512
MSE: 0.002771, MAE: 0.023984
MSE per time: [0.00028014 0.00079776 0.00179791 0.00371928 0.00725995]
MAE per time: [0.0092198  0.01613979 0.02332672 0.03112968 0.04010308]

==================================================
Context Length: 768
MSE: 0.002024, MAE: 0.019064
MSE per time: [0.00011165 0.00046078 0.0017915  0.00313302 0.00462363]
MAE per time: [0.00603702 0.01158123 0.01942525 0.02554441 0.03273133]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_6_fully_trained_behaviour_8_1.png" src="../_images/notebooks_6_fully_trained_behaviour_8_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_6_fully_trained_behaviour_8_2.png" src="../_images/notebooks_6_fully_trained_behaviour_8_2.png" />
</div>
</div>
<p>Here, we can see a clear trend: as the <strong>context window size increases, the model’s forecasting performance improves</strong>. This is expected, as the model has more historical data to base its predictions on. However, the improvement is not linear, indicating that the model may struggle with long-range dependencies or memory limitations. This information will be crucial for fine-tuning the model and optimizing its performance on this task.</p>
<p>Also, <strong>as the model generates predictions further into the future, the forecasting error increases</strong>. This is expected, as the model is making predictions based on its own generated outputs, which may introduce compounding errors. This trend is important to consider when designing forecasting systems that rely on autoregressive models.</p>
<p>Finally, for the cross-entropy loss, <strong>we can see that there is a interesting zig-zag pattern</strong>. Notice that the loss sometimes reaches zero, and then jumps back up. <strong>The zero is due to the fact that the model have learnt that after a few steps, there must be a semicolon, and then the pattern repeats</strong>. The semi-colon, the comma and the period are quite predictable tokens, and the model can learn to generalize them quite well. However, for the numerical values, the model struggles more, and the
loss increases as the model tries to predict into the future.</p>
<p>When we apply a moving average of 10 steps to the loss, we can see that the zig-zag pattern is smoothed out, and we can see a more clear trend of the loss increasing over time. This is a common technique to visualize trends in noisy data, and can help us understand the overall performance of the model better. We can additionally see that again the model performs better with a larger context window, as it has more information to base its predictions on.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flops_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">flops_logger</span><span class="o">.</span><span class="n">log_file</span><span class="p">)</span>
<span class="n">flops_used</span> <span class="o">=</span> <span class="n">flops_df</span><span class="p">[</span><span class="n">flops_df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">flops_logger</span><span class="o">.</span><span class="n">log_name</span><span class="p">]</span><span class="o">.</span><span class="n">flops</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FLOPS used: </span><span class="si">{</span><span class="n">flops_used</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> or 1e</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">flops_used</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">. Using </span><span class="si">{</span><span class="n">flops_used</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1e17</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% of the Budget&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
FLOPS used: 16210063752722528 or 1e16.21. Using 16.21% of the Budget
</pre></div></div>
</div>
</section>
</section>
<section id="Flops-Analysis">
<h1>Flops Analysis<a class="headerlink" href="#Flops-Analysis" title="Link to this heading"></a></h1>
<p>Our analysis shows that even using only 1% of the data (10 % of the evaluation set, where the evaluation set is 10% of the entire dataset) already consumes 1.3% of the total computational budget, meaning each validation experiment costs approximately 0.4% of our budget. Since validation will be run multiple times in an experiment, and we have at least 12 experiments planned (3 [rank search] × 3 [learning rate search] + 3 [context length search]), this approach to validation is computationally
expensive.</p>
<p>Therefore, I propose reducing the forecast horizon from 5 to 3 timestamps. This modification will decrease FLOPS usage by approximately 40%, making our experiments significantly more efficient.</p>
<p>This decision is supported by our observations: for the first 2 timestamps, MSE and MAE are relatively similar across different context lengths. However, as error propagates, the third timestamp is where performance between models begins to meaningfully diverge. The plots above demonstrate a clear difference in MSE and MAE values at the third timestamp, making it a suitable evaluation point while conserving computational resources.</p>
<p>Below, we show the updated results for the 3-timestamp forecast horizon.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot 2: MSE and MAE vs context length</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">mse_by_context</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MSE_</span><span class="si">{</span><span class="n">cl</span><span class="si">}</span><span class="s1">_per_time&#39;</span><span class="p">])[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">context_lengths</span><span class="p">]</span>
<span class="n">mae_by_context</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MAE_</span><span class="si">{</span><span class="n">cl</span><span class="si">}</span><span class="s1">_per_time&#39;</span><span class="p">])[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">context_lengths</span><span class="p">]</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">context_lengths</span><span class="p">,</span> <span class="n">mse_by_context</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MSE&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">context_lengths</span><span class="p">,</span> <span class="n">mae_by_context</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MAE&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Error Metrics by Context Length&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Context Length&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Error Value&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">context_lengths</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">for</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context Length: </span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;MSE: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;MSE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s2">_per_time&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:</span><span class="mi">3</span><span class="p">])</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;MAE: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logged_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;MAE_</span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="s2">_per_time&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:</span><span class="mi">3</span><span class="p">])</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_6_fully_trained_behaviour_12_0.png" src="../_images/notebooks_6_fully_trained_behaviour_12_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
==================================================
Context Length: 128, MSE: 0.008, MAE: 0.042
==================================================
Context Length: 512, MSE: 0.001, MAE: 0.016
==================================================
Context Length: 768, MSE: 0.001, MAE: 0.012
</pre></div></div>
</div>
<section id="Results-Analysis">
<h2>Results Analysis<a class="headerlink" href="#Results-Analysis" title="Link to this heading"></a></h2>
<p>The metrics above reveal how accurately the untrained Qwen2.5-0.5B model can forecast predator-prey dynamics. Several observations:</p>
<ol class="arabic simple">
<li><p><strong>Context Length Impact</strong>: We can see how prediction accuracy varies with different context window sizes.</p></li>
<li><p><strong>Error Progression</strong>: The per-timestep metrics show how errors accumulate (or potentially stabilize) as the model predicts further into the future.</p></li>
<li><p><strong>Overall Performance</strong>: The aggregate MSE and MAE values establish our baseline performance, which we’ll aim to improve through LoRA fine-tuning.</p></li>
<li><p><strong>FLOPS Accounting</strong>: We’ve carefully tracked all computational costs to ensure our experiments remain within budget constraints.</p></li>
</ol>
<p>These baseline results inform our fine-tuning strategy by highlighting:</p>
<ul class="simple">
<li><p>The optimal context window size for balancing performance and computational efficiency</p></li>
<li><p>The model’s inherent limitations on temporal forecasting</p></li>
<li><p>Specific patterns where the model struggles most (which may require dedicated attention during fine-tuning)</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get the first two chain</span>
<span class="n">datas</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">predicted</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">semi_colon_max</span> <span class="o">=</span> <span class="mi">20</span>
<span class="k">for</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">):</span>
    <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="n">data_master</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span>
        <span class="n">context_length</span><span class="o">=</span><span class="n">context_length</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">target_eval_pairs</span> <span class="o">=</span> <span class="n">semi_colon_max</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">temp_test_loader_active</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">test_loader</span><span class="p">)</span>
    <span class="n">datas</span><span class="p">[</span><span class="n">context_length</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="n">temp_test_loader_active</span><span class="p">)]</span>
    <span class="n">datas</span><span class="p">[</span><span class="n">context_length</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">temp_test_loader_active</span><span class="p">))</span>




<span class="n">processor</span> <span class="o">=</span> <span class="n">data_master</span><span class="o">.</span><span class="n">processor</span>

<span class="n">flops_logger</span> <span class="o">=</span> <span class="n">QwenFlopsCalculator</span><span class="p">()</span>


<span class="n">Total_flops_used</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Flops_counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>



<span class="k">for</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">):</span>
    <span class="n">result</span><span class="p">[</span><span class="n">context_length</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="n">data_master</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span>
        <span class="n">context_length</span><span class="o">=</span><span class="n">context_length</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">target_eval_pairs</span> <span class="o">=</span> <span class="n">semi_colon_max</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="p">)</span>
    <span class="c1"># claer tqdm instance</span>
    <span class="n">tqdm</span><span class="o">.</span><span class="n">_instances</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">datas</span><span class="p">[</span><span class="n">context_length</span><span class="p">]:</span>

        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># we allow the model infer until (reached 2 * target length) or the model predict the end token (semi-colon token -&gt; 26)</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="n">semi_colon_max</span> <span class="o">*</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">original_length</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">semi_colon_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">per_step_ce</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_length</span><span class="p">):</span>

                <span class="n">flops_logger</span><span class="o">.</span><span class="n">log_flops</span><span class="p">(</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">seq_len</span><span class="o">=</span><span class="n">context_length</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">inference</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;MSE Untrained Evaluation&quot;</span><span class="p">)</span>

                <span class="c1"># only use context length size of input_ids to predict the next token</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_ids</span><span class="p">[:,</span> <span class="o">-</span><span class="n">context_length</span><span class="p">:])</span>
                <span class="n">next_token_logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">logits</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">next_token</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">next_token_logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">next_token</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># get the CE loss</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">next_token_logits</span><span class="p">,</span> <span class="n">target</span><span class="p">[:,</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">original_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">per_step_ce</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

                <span class="k">if</span> <span class="n">next_token</span> <span class="o">==</span> <span class="mi">26</span><span class="p">:</span>
                    <span class="n">semi_colon_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">semi_colon_count</span> <span class="o">==</span> <span class="n">semi_colon_max</span><span class="p">:</span>
                        <span class="k">break</span>

        <span class="n">result</span><span class="p">[</span><span class="n">context_length</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_ids</span><span class="p">[:,</span> <span class="n">original_length</span><span class="p">:]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>


    <span class="n">flops_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">flops_logger</span><span class="o">.</span><span class="n">log_file</span><span class="p">)</span>
    <span class="n">current_exp_flops</span> <span class="o">=</span> <span class="n">flops_df</span><span class="p">[</span><span class="n">flops_df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">flops_logger</span><span class="o">.</span><span class="n">log_name</span><span class="p">]</span>
    <span class="n">Total_flops_used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">current_exp_flops</span><span class="o">.</span><span class="n">flops</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">Flops_counter</span>
    <span class="p">)</span>
    <span class="n">Flops_counter</span> <span class="o">=</span> <span class="n">current_exp_flops</span><span class="o">.</span><span class="n">flops</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>


<span class="c1"># print the Total_flops_used</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">flops</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Total_flops_used</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total FLOPS used for context length </span><span class="si">{</span><span class="p">[</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">512</span><span class="p">,</span><span class="w"> </span><span class="mi">768</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">flops</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">, -- [</span><span class="si">{</span><span class="n">flops</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1e17</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> percent of budget]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 3200 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 300 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 300 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train:   0%|          | 0/3200 [00:00&lt;?, ?it/s]
Sanity check Train:   0%|          | 1/3200 [00:00&lt;20:10,  2.64it/s]
Sanity check Train: 100%|██████████| 3200/3200 [00:00&lt;00:00, 6268.83it/s]
Sanity check:  33%|███▎      | 1/3 [00:00&lt;00:01,  1.95it/s]
Sanity check Val: 100%|██████████| 300/300 [00:00&lt;00:00, 23749.41it/s]

Sanity check Test: 100%|██████████| 300/300 [00:00&lt;00:00, 23805.12it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 1604 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 200 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 200 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 1604/1604 [00:00&lt;00:00, 23408.79it/s]

Sanity check Val: 100%|██████████| 200/200 [00:00&lt;00:00, 23140.99it/s]

Sanity check Test: 100%|██████████| 200/200 [00:00&lt;00:00, 22916.56it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 804 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 100 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 100 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 804/804 [00:00&lt;00:00, 23300.24it/s]

Sanity check Val: 100%|██████████| 100/100 [00:00&lt;00:00, 21764.85it/s]

Sanity check Test: 100%|██████████| 100/100 [00:00&lt;00:00, 21652.49it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 3200 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 300 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 300 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train:   0%|          | 0/3200 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 3200/3200 [00:00&lt;00:00, 24245.58it/s]
Sanity check:  33%|███▎      | 1/3 [00:00&lt;00:00,  7.49it/s]
Sanity check Val: 100%|██████████| 300/300 [00:00&lt;00:00, 23933.72it/s]

Sanity check Test: 100%|██████████| 300/300 [00:00&lt;00:00, 23930.53it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 1604 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 200 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 200 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 1604/1604 [00:00&lt;00:00, 23751.68it/s]

Sanity check Val: 100%|██████████| 200/200 [00:00&lt;00:00, 22837.33it/s]

Sanity check Test: 100%|██████████| 200/200 [00:00&lt;00:00, 22576.12it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 804 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 100 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 100 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 804/804 [00:00&lt;00:00, 23249.64it/s]

Sanity check Val: 100%|██████████| 100/100 [00:00&lt;00:00, 21939.03it/s]

Sanity check Test: 100%|██████████| 100/100 [00:00&lt;00:00, 21798.78it/s]

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Total FLOPS used for context length 128: 6.121e+13, -- [0.061 percent of budget]
Total FLOPS used for context length 512: 2.603e+14, -- [0.260 percent of budget]
Total FLOPS used for context length 768: 4.008e+14, -- [0.401 percent of budget]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><br/><br/><span></span><span class="c1"># for each</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
<span class="n">context_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#1f77b4&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff7f0e&#39;</span><span class="p">,</span> <span class="s1">&#39;#2ca02c&#39;</span><span class="p">,</span> <span class="s1">&#39;#d62728&#39;</span><span class="p">]</span>
<span class="n">examples</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Example 1&quot;</span><span class="p">,</span> <span class="s2">&quot;Example 2&quot;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">context_lengths</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">datas</span><span class="p">[</span><span class="n">context_length</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="n">full_sequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">target</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Process data for plotting</span>
        <span class="n">full_sequence_values</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">postprocess</span><span class="p">(</span><span class="n">full_sequence</span><span class="p">)</span>
        <span class="n">input_ids_values</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">postprocess</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span>

        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">decode_to_string</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">context_length</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
        <span class="c1"># Split by semicolons and process each pair</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">result_ids_values</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">semi_colon_count</span><span class="p">]</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">result_ids_values</span><span class="p">]</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">]</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">result_ids_values</span><span class="p">]</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result_ids_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1"># Apply scaling factor to get actual values</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">result_ids_values</span> <span class="o">/</span> <span class="n">processor</span><span class="o">.</span><span class="n">scaler</span>      <span class="c1"># decode the values</span>

        <span class="n">result_time</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_ids_values</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">))</span>

        <span class="c1"># Plot predator population</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">full_sequence_values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Context&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">result_time</span><span class="p">,</span> <span class="n">result_ids_values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Plot prey population</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">full_sequence_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Context&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">result_time</span><span class="p">,</span> <span class="n">result_ids_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                          <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Set titles and labels</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context Length: </span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">examples</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2"> - Predator Population&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context Length: </span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">examples</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2"> - Prey Population&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

        <span class="c1"># Add grid and legend to make the plots more readable</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Population&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

            <span class="c1"># Only show x label on bottom row</span>
            <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time Step&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Add overall title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Predator-Prey Time Series Forecasting by Context Length&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.98</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/><br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_6_fully_trained_behaviour_16_0.png" src="../_images/notebooks_6_fully_trained_behaviour_16_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datas</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">predicted</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">semi_colon_max</span> <span class="o">=</span> <span class="mi">20</span>
<span class="k">for</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">):</span>
    <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="n">data_master</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span>
        <span class="n">context_length</span><span class="o">=</span><span class="n">context_length</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">target_eval_pairs</span> <span class="o">=</span> <span class="n">semi_colon_max</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">temp_test_loader_active</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">test_loader</span><span class="p">)</span>
    <span class="n">datas</span><span class="p">[</span><span class="n">context_length</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="n">temp_test_loader_active</span><span class="p">)]</span>
    <span class="n">datas</span><span class="p">[</span><span class="n">context_length</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">temp_test_loader_active</span><span class="p">))</span>




<span class="n">processor</span> <span class="o">=</span> <span class="n">data_master</span><span class="o">.</span><span class="n">processor</span>

<span class="n">flops_logger</span> <span class="o">=</span> <span class="n">QwenFlopsCalculator</span><span class="p">()</span>


<span class="n">Total_flops_used</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Flops_counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">semi_colon_max</span> <span class="o">=</span> <span class="mi">200</span>


<span class="k">for</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">):</span>
    <span class="n">result</span><span class="p">[</span><span class="n">context_length</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="n">data_master</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span>
        <span class="n">context_length</span><span class="o">=</span><span class="n">context_length</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">target_eval_pairs</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="p">)</span>
    <span class="c1"># claer tqdm instance</span>
    <span class="n">tqdm</span><span class="o">.</span><span class="n">_instances</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">datas</span><span class="p">[</span><span class="n">context_length</span><span class="p">]:</span>

        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># we allow the model infer until (reached 2 * target length) or the model predict the end token (semi-colon token -&gt; 26)</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="n">semi_colon_max</span> <span class="o">*</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">original_length</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">semi_colon_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">per_step_ce</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_length</span><span class="p">):</span>

                <span class="n">flops_logger</span><span class="o">.</span><span class="n">log_flops</span><span class="p">(</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">seq_len</span><span class="o">=</span><span class="n">context_length</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">inference</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;MSE Untrained Evaluation&quot;</span><span class="p">)</span>

                <span class="c1"># only use context length size of input_ids to predict the next token</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_ids</span><span class="p">[:,</span> <span class="o">-</span><span class="n">context_length</span><span class="p">:])</span>
                <span class="n">next_token_logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">logits</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">next_token</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">next_token_logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">next_token</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># get the CE loss</span>
<span class="c1">#                 loss = torch.nn.functional.cross_entropy(next_token_logits, target[:, input_ids.shape[1] - original_length - 1])</span>
<span class="c1">#                 per_step_ce.append(loss.item())</span>

                <span class="k">if</span> <span class="n">next_token</span> <span class="o">==</span> <span class="mi">26</span><span class="p">:</span>
                    <span class="n">semi_colon_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">semi_colon_count</span> <span class="o">==</span> <span class="n">semi_colon_max</span><span class="p">:</span>
                        <span class="k">break</span>

        <span class="n">result</span><span class="p">[</span><span class="n">context_length</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_ids</span><span class="p">[:,</span> <span class="n">original_length</span><span class="p">:]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>


    <span class="n">flops_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">flops_logger</span><span class="o">.</span><span class="n">log_file</span><span class="p">)</span>
    <span class="n">current_exp_flops</span> <span class="o">=</span> <span class="n">flops_df</span><span class="p">[</span><span class="n">flops_df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">flops_logger</span><span class="o">.</span><span class="n">log_name</span><span class="p">]</span>
    <span class="n">Total_flops_used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">current_exp_flops</span><span class="o">.</span><span class="n">flops</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">Flops_counter</span>
    <span class="p">)</span>
    <span class="n">Flops_counter</span> <span class="o">=</span> <span class="n">current_exp_flops</span><span class="o">.</span><span class="n">flops</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>


<span class="c1"># print the Total_flops_used</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">flops</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Total_flops_used</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total FLOPS used for context length </span><span class="si">{</span><span class="p">[</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">512</span><span class="p">,</span><span class="w"> </span><span class="mi">768</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">flops</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">, -- [</span><span class="si">{</span><span class="n">flops</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1e17</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> percent of budget]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 3200 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 300 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 300 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train:   0%|          | 0/3200 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 3200/3200 [00:00&lt;00:00, 24523.25it/s]
Sanity check:  33%|███▎      | 1/3 [00:00&lt;00:00,  7.57it/s]
Sanity check Val: 100%|██████████| 300/300 [00:00&lt;00:00, 24279.15it/s]

Sanity check Test: 100%|██████████| 300/300 [00:00&lt;00:00, 23760.62it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 1604 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 200 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 200 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 1604/1604 [00:00&lt;00:00, 24171.62it/s]

Sanity check Val: 100%|██████████| 200/200 [00:00&lt;00:00, 23331.50it/s]

Sanity check Test: 100%|██████████| 200/200 [00:00&lt;00:00, 23446.93it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 804 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 100 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 100 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 804/804 [00:00&lt;00:00, 23481.79it/s]

Sanity check Val: 100%|██████████| 100/100 [00:00&lt;00:00, 22060.19it/s]

Sanity check Test: 100%|██████████| 100/100 [00:00&lt;00:00, 22034.69it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 3200 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 300 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 300 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train:   0%|          | 0/3200 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 3200/3200 [00:00&lt;00:00, 24026.57it/s]
Sanity check:  33%|███▎      | 1/3 [00:00&lt;00:00,  7.42it/s]
Sanity check Val: 100%|██████████| 300/300 [00:00&lt;00:00, 23886.92it/s]

Sanity check Test: 100%|██████████| 300/300 [00:00&lt;00:00, 24010.44it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 1604 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 200 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 200 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 1604/1604 [00:00&lt;00:00, 24076.64it/s]

Sanity check Val: 100%|██████████| 200/200 [00:00&lt;00:00, 22795.13it/s]

Sanity check Test: 100%|██████████| 200/200 [00:00&lt;00:00, 23548.95it/s]

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 804 chunks from 800 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 100 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created 100 chunks from 100 sequences
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sanity check:   0%|          | 0/3 [00:00&lt;?, ?it/s]
Sanity check Train: 100%|██████████| 804/804 [00:00&lt;00:00, 23088.70it/s]

Sanity check Val: 100%|██████████| 100/100 [00:00&lt;00:00, 21636.85it/s]

Sanity check Test: 100%|██████████| 100/100 [00:00&lt;00:00, 21522.50it/s]

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Total FLOPS used for context length 128: 6.291e+14, -- [0.629 percent of budget]
Total FLOPS used for context length 512: 2.670e+15, -- [2.670 percent of budget]
Total FLOPS used for context length 768: 4.134e+15, -- [4.134 percent of budget]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># save data</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;qwen_finetune_lora_result.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;qwen_finetune_lora_datas.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">datas</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

<span class="c1"># read it</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;qwen_finetune_lora_result.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;qwen_finetune_lora_datas.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">datas</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for each</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">500</span><span class="p">)</span>
<span class="n">context_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#1f77b4&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff7f0e&#39;</span><span class="p">,</span> <span class="s1">&#39;#2ca02c&#39;</span><span class="p">,</span> <span class="s1">&#39;#d62728&#39;</span><span class="p">]</span>
<span class="n">examples</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Example 1&quot;</span><span class="p">,</span> <span class="s2">&quot;Example 2&quot;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">context_lengths</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">datas</span><span class="p">[</span><span class="n">context_length</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="n">full_sequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">target</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Process data for plotting</span>
        <span class="n">full_sequence_values</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">postprocess</span><span class="p">(</span><span class="n">full_sequence</span><span class="p">)</span>
        <span class="n">input_ids_values</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">postprocess</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">decode_to_string</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">context_length</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
        <span class="c1"># Split by semicolons and process each pair</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">result_ids_values</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">semi_colon_count</span><span class="p">]</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">result_ids_values</span><span class="p">]</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">]</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">result_ids_values</span><span class="p">]</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result_ids_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1"># Apply scaling factor to get actual values</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">result_ids_values</span> <span class="o">/</span> <span class="n">processor</span><span class="o">.</span><span class="n">scaler</span>      <span class="c1"># decode the values</span>
        <span class="n">result_time</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_ids_values</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">))</span>

        <span class="c1"># Plot predator population</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Context&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">full_sequence_values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">result_time</span><span class="p">,</span> <span class="n">result_ids_values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Plot prey population</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Context&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">full_sequence_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">result_time</span><span class="p">,</span> <span class="n">result_ids_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                          <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Set titles and labels</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context Length: </span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">examples</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2"> - Predator Population&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context Length: </span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">examples</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2"> - Prey Population&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

        <span class="c1"># Add grid and legend to make the plots more readable</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Population&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

            <span class="c1"># Only show x label on bottom row</span>
            <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time Step&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Add overall title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Predator-Prey Time Series Forecasting by Context Length&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.98</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/><br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_6_fully_trained_behaviour_19_0.png" src="../_images/notebooks_6_fully_trained_behaviour_19_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for each</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span>
<span class="n">context_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#1f77b4&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff7f0e&#39;</span><span class="p">,</span> <span class="s1">&#39;#2ca02c&#39;</span><span class="p">,</span> <span class="s1">&#39;#d62728&#39;</span><span class="p">]</span>
<span class="n">examples</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Example 1&quot;</span><span class="p">,</span> <span class="s2">&quot;Example 2&quot;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">context_length</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">context_lengths</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">datas</span><span class="p">[</span><span class="n">context_length</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="n">full_sequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">target</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Process data for plotting</span>
        <span class="n">full_sequence_values</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">postprocess</span><span class="p">(</span><span class="n">full_sequence</span><span class="p">)</span>
        <span class="n">input_ids_values</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">postprocess</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">decode_to_string</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">context_length</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
        <span class="c1"># Split by semicolons and process each pair</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">result_ids_values</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">semi_colon_count</span><span class="p">]</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">result_ids_values</span><span class="p">]</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">]</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">result_ids_values</span><span class="p">]</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result_ids_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1"># Apply scaling factor to get actual values</span>
        <span class="n">result_ids_values</span> <span class="o">=</span> <span class="n">result_ids_values</span> <span class="o">/</span> <span class="n">processor</span><span class="o">.</span><span class="n">scaler</span>      <span class="c1"># decode the values</span>
        <span class="n">result_time</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_ids_values</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">))</span>

        <span class="c1"># Plot predator population</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Context&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">full_sequence_values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">result_time</span><span class="p">,</span> <span class="n">result_ids_values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Plot prey population</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">input_ids_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Context&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">full_sequence_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">result_time</span><span class="p">,</span> <span class="n">result_ids_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                          <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Set titles and labels</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context Length: </span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">examples</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2"> - Predator Population&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context Length: </span><span class="si">{</span><span class="n">context_length</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">examples</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2"> - Prey Population&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

        <span class="c1"># Add grid and legend to make the plots more readable</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Population&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

            <span class="c1"># Only show x label on bottom row</span>
            <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time Step&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Add overall title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Predator-Prey Time Series Forecasting by Context Length&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.98</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/><br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_6_fully_trained_behaviour_20_0.png" src="../_images/notebooks_6_fully_trained_behaviour_20_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prompt_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;How many r in strawberry?&quot;</span><span class="p">,</span>
    <span class="s2">&quot;what is the result of 1 + 1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;what is the result of 0.12 + 3.24&quot;</span><span class="p">,</span>
    <span class="s2">&quot;0, 1, 1, 2, 3, 5, 8,&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Write a poem that uses numbers as metaphors. For instance, start with &#39;1.20, 1.31; 0.93, 0.98&#39; and explore what these figures might mean in life.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Craft a poem that tells a story of dreams and memories, using punctuation naturally to evoke a rhythmic, lyrical quality.&quot;</span>

<span class="p">]</span>

<span class="k">for</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="n">prompt_list</span><span class="p">:</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;You are Qwen, created by Alibaba Cloud. You are a helpful assistant.&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}</span>
    <span class="p">]</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
        <span class="n">messages</span><span class="p">,</span>
        <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">add_generation_prompt</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">model_inputs</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">([</span><span class="n">text</span><span class="p">],</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="n">generated_ids</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
        <span class="o">**</span><span class="n">model_inputs</span><span class="p">,</span>
        <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">512</span>
    <span class="p">)</span>
    <span class="n">generated_ids</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">output_ids</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">input_ids</span><span class="p">):]</span> <span class="k">for</span> <span class="n">input_ids</span><span class="p">,</span> <span class="n">output_ids</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">model_inputs</span><span class="o">.</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">generated_ids</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">generated_ids</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">=========================</span>
<span class="s2">Question: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span>
<span class="s2">---</span>
<span class="s2">Response: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span>
<span class="s2">=========================</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

=========================
Question: How many r in strawberry?
---
Response: In the Chinese language, &#34;strawberry&#34; is written as &#34;qiǎnér&#34;, which consists of two characters: &#34;qiǎn&#34; (straw) and &#34;lěi&#34; (berry). The character &#34;qiǎn&#34; represents the sound of the tongue moving forward while swallowing air, while &#34;lěi&#34; represents the word &#34;berry&#34;. Therefore, &#34;qiǎnlěi&#34; means &#34;strawberry&#34;.

So, to sum up, &#34;strawberry&#34; can be represented as &#34;qiǎnlěi&#34;, which is a simplified version of the original &#34;qiǎntéir&#34;. This name was given to the fruit because it&#39;s derived from the combination of the first two letters of the words &#34;straw&#34; and &#34;berry&#34;, and also reflects the shape and taste of the fruit.
=========================


=========================
Question: what is the result of 1 + 1
---
Response: The result of 1 + 1 is 2. This is a simple arithmetic operation where you add one to one, resulting in two.
=========================


=========================
Question: what is the result of 0.12 + 3.24
---
Response: The result of adding 0.12 and 3.24 is 3.36.

This calculation involves basic addition of two numbers:

1. Start with the first number: 0.12.
2. Add the second number: 3.24.
3. Perform the addition as follows:
   - 0.12 + 0.2 = 0.32
   - 0.32 + 0.2 = 0.52
   - 0.52 + 0.2 = 0.72
   - 0.72 + 0.2 = 0.92
   - 0.92 + 0.2 = 1.12

So, 0.12 + 3.24 = 3.36.

Therefore, the final answer to 0.12 + 3.24 is 3.36.
=========================


=========================
Question: 0, 1, 1, 2, 3, 5, 8,
---
Response: The sequence you&#39;ve provided is an arithmetic sequence where each term increases by a constant difference. Let&#39;s break it down step-by-step:

1. The first term \(a_1\) is 0.
2. The second term \(a_2\) is 1.
3. The third term \(a_3\) is 1 (since \(a_1 + d = 1\)).
4. The fourth term \(a_4\) is 2 (since \(a_2 + d = 2\)).
5. The fifth term \(a_5\) is 3 (since \(a_3 + d = 3\)).
6. The sixth term \(a_6\) is 5 (since \(a_4 + d = 5\)).

We can see that the terms follow a pattern of increasing by one for every three terms. To find the general formula for the \(n\)-th term of this sequence, we can use the following steps:

- The first term \(a_1 = 0\).
- The second term \(a_2 = 1\).
- The third term \(a_3 = 1 + 1 = 2\).
- The fourth term \(a_4 = 2 + 1 = 3\).
- The fifth term \(a_5 = 3 + 1 = 4\).

Following this pattern, the \(n\)-th term \(a_n\) can be calculated as:
\[a_n = a_{n-1} + (n - 1)\]

So, for \(n = 5\):
\[a_5 = a_4 + 4 = 3 + 4 = 7\]
For \(n = 6\):
\[a_6 = a_5 + 5 = 7 + 5 = 12\]

This pattern continues with the next term being 16. Therefore, the general formula for the \(n\)-th term of this sequence is:
\[a_n = n^2 + n - 2\]

Using this formula, we can calculate any term in the sequence. For example, to find the 10th term (\(a_{10}\)):
\[a_{10} = 10^2 + 10 - 2 = 100 + 9 = 109\]

Let me know if you need any other calculations or have additional questions!
=========================


=========================
Question: Write a poem that uses numbers as metaphors. For instance, start with &#39;1.20, 1.31; 0.93, 0.98&#39; and explore what these figures might mean in life.
---
Response: In the vast expanse of our existence,
Numbers dance, like shadows on the page.
They tell us not just how we move,
But also, how we grow, and how we fall.

Let&#39;s count our blessings, one by one,
With each step, with every drop of sweat.
Our lives are but a fraction of this grand design,
A testament to the universe&#39;s might.

So let us cherish every moment spent,
And remember, that even the smallest steps,
Are a testament to the power within us all.

For in this world, where we find ourselves,
We are but a part of something so great.
The numbers of our hearts, the wisdom we gain,
Will shape the future, a tale of wonder.

So let us embrace life, with love and grace,
For in its depths, there lies an endless story.
For though our numbers may be small,
Yet they hold the key to understanding the whole.
=========================


=========================
Question: Craft a poem that tells a story of dreams and memories, using punctuation naturally to evoke a rhythmic, lyrical quality.
---
Response: In the dreamland where your eyes behold,
A world beyond this earthly sight,
Where time seems but a fleeting flash,
Of moments lost in the vastness.

Your heart beats like a drumbeat,
As you dance under the stars so bright,
Through every waking thought and silent sigh,
The memories of yesterday still linger.

In this realm of dreams, where the past is not gone,
A tapestry of love and sorrow unfolds.
Each memory, a thread woven from threads spun so fine,
That they all weave into one, a web of life.

With each step, with every breath, there&#39;s a new dawn,
And in the midst of chaos and strife, there&#39;s hope.
For in this world of dreams and nightmares,
There lies an inner light, a beacon of hope.
=========================

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prompt_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;How many r in strawberry?&quot;</span><span class="p">,</span>
    <span class="s2">&quot;what is the result of 1 + 1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;what is the result of 0.12 + 3.24&quot;</span><span class="p">,</span>
    <span class="s2">&quot;0, 1, 1, 2, 3, 5, 8,&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Write a poem that uses numbers as metaphors. For instance, start with &#39;1.20, 1.31; 0.93, 0.98&#39; and explore what these figures might mean in life.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Craft a poem that tells a story of dreams and memories, using punctuation naturally to evoke a rhythmic, lyrical quality.&quot;</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="n">prompt_list</span><span class="p">:</span>
    <span class="c1"># Tokenize the prompt directly</span>
    <span class="n">model_inputs</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">([</span><span class="n">prompt</span><span class="p">],</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># Generate text</span>
    <span class="n">generated_ids</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
        <span class="o">**</span><span class="n">model_inputs</span><span class="p">,</span>
        <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">512</span>
    <span class="p">)</span>

    <span class="c1"># Extract only the newly generated tokens</span>
    <span class="n">generated_ids</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">output_ids</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">input_ids</span><span class="p">):]</span> <span class="k">for</span> <span class="n">input_ids</span><span class="p">,</span> <span class="n">output_ids</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">model_inputs</span><span class="o">.</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">generated_ids</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Decode the generated tokens</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">generated_ids</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">=========================</span>
<span class="s2">Prompt: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span>
<span class="s2">---</span>
<span class="s2">Response: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span>
<span class="s2">=========================</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

=========================
Prompt: How many r in strawberry?
---
Response:  - 1,000,000

What is the answer?

The number of r (rings) in a strawberry is approximately 1,000,000. This can vary slightly depending on the species and cultivar of the strawberry plant, but it&#39;s generally considered to be around this figure. The exact count can differ slightly based on specific genetic variations within a single plant. For instance, some varieties may have slightly different numbers of rings, so this number remains an average for most strawberries.
=========================


=========================
Prompt: what is the result of 1 + 1
---
Response: , if you subtract one from two?

The result of \(1 + 1\) is \(2\).

If you then subtract one from two, which equals \(1\), the final result is:

\(2 - 1 = 1\).

So, the final answer is \(1\).
=========================


=========================
Prompt: what is the result of 0.12 + 3.24
---
Response: , when both numbers are multiplied by their respective reciprocals?

To find the result of \(0.12 \times 3.24\) and then multiply that result by the reciprocal of both numbers, we can follow these steps:

First, calculate \(0.12 \times 3.24\):
\[0.12 \times 3.24 = 0.3968\]

Next, find the reciprocal of each number:
The reciprocal of \(0.12\) is \(10\), and the reciprocal of \(3.24\) is \(\frac{1}{3.24}\).

Now, multiply the two results together:
\[0.3968 \times \frac{1}{3.24} = \frac{0.3968}{3.24} \approx 0.1257\]

So, the final answer is:
\[\boxed{0.1257}\]
=========================


=========================
Prompt: 0, 1, 1, 2, 3, 5, 8,
---
Response:  14, 27, 48, 91, 197, 419, 969, 2184, 5160, 12000, 31240, 80288, 219088, 658342, 1799038, 5178472, 15162688, 46956488, 139472218, 428836880, 1290396828, 3929024798, 11277984829, 38444456323, 112374844497, 382374439369, 1267944432769, 4192963848494, 13777865725529, 45858298248388, 149078689276495, 514995738653079, 1794094622643868, 6189577536396998, 20928374579678978, 75397625930299864, 256868583835676824, 929777877534784428, 3557232766292493542, 12789576988279286896, 45248698837968575950, 165762384778345426
=========================


=========================
Prompt: Write a poem that uses numbers as metaphors. For instance, start with &#39;1.20, 1.31; 0.93, 0.98&#39; and explore what these figures might mean in life.
---
Response:  The poem should be about the interconnectedness of human experiences, the beauty of numbers, and the power of understanding. It could include a chorus of &#34;numbers are not just numbers, they&#39;re the keys to our lives,&#34; and an interlude of &#34;the numbers we&#39;ve seen before&#34; and &#34;the numbers we&#39;ll see again.&#34; The final stanza will celebrate the journey of discovery and growth through numbers, encouraging readers to embrace their unique path. Here&#39;s a possible structure for your poem:

1. **1.20, 1.31; 0.93, 0.97**
   - *Numbers intertwine, forming a tapestry of existence.*
   - *Each number tells a story, weaving together our lives.*

2. **The sum of all, the sum is vast:**
   - *Numbers reflect the complexity of our universe.*
   - *Their sum is the essence of reality.*

3. **For every step forward, there’s another one behind:**
   - *Numbers guide us through the journey of life.*
   - *They illuminate paths, guiding us toward new horizons.*

4. **In the heart of each equation, the heart beats strong:**
   - *Our numbers, intertwined, form the foundation of our being.*
   - *Together, they sustain us, shaping our destiny.*

5. **As we navigate through the unknowns, numbers become allies:**
   - *They offer a shield against uncertainty.*
   - *They guide us through challenges, providing strength and guidance.*

6. **The numbers we’ve encountered before, now serve as mirrors:**
   - *We learn from them, growing and evolving.*
   - *We find meaning in their patterns, making us stronger.*

7. **The numbers we’ll encounter next, they’re yet to come:**
   - *A future filled with possibilities lies ahead.*
   - *With each new number, we embark on a new adventure.*

8. **The journey of discovery, it’s a constant dance:**
   - *Numbers bring us closer to our goals,*
   - *And we find the courage to pursue them.*

9. **The numbers we’ve experienced, they shape our identity:**
   - *They define who we are, shaping our character.*
   - *Together, they create a narrative of our lives.*

10. **In the end, the numbers we hold dear are eternal:**
    - *Our hearts, forever entwined by
=========================


=========================
Prompt: Craft a poem that tells a story of dreams and memories, using punctuation naturally to evoke a rhythmic, lyrical quality.
---
Response:  The poem should be at least 10 lines long, incorporating imagery and metaphors, and expressing the idea that our dreams are reflections of our deepest desires and aspirations.

In the quiet of my mind&#39;s eye,
Where shadows dance on glassy skies,
My heart beats as if in a dream,
A melody played by stars and seas.

The moon, a mirror so bright,
Reflects my thoughts with a glow,
And in its embrace, I find solace,
For in its light, all my fears can find release.

The wind whispers tales from the trees,
Of lands yet unseen, where we may roam,
A world where beauty and pain blend,
A tapestry woven from threads of love.

I dream of mountains high and vast,
Of rivers flowing like hearts and eyes,
Of oceans wide and endless blue,
Of sunsets that fade into night.

The sea calls me, the land calls me,
My soul finds peace when it swims,
For in the depths, I am free,
To wander where my heart desires.

As I wake, my spirit filled,
With memories of days gone by,
Of laughter, tears, and smiles true,
That will forever shine through my eyes.

So let this poem guide your way,
To find your path, to find what you seek,
For in each dream, there is hope,
And every memory brings a new page.

And though the road ahead may seem dark,
We must not lose sight of our dreams,
For they are the keys to the future,
And we shall walk them with courage.

And as the stars twinkle below,
And the waves crash upon the shore,
Let us hold onto the memories,
And let them guide us to our goal.

For in their echoes, we find
Our strength, our courage, and our guide.
For in our dreams, we find our home,
And we shall live life to the fullest.

And so, let us cherish each moment,
And know that even in the darkest hour,
There is always a glimmer of hope,
That will light the way for us to rise.

In the end, it is up to us,
To choose our path, and let it lead,
For only then can we truly thrive,
And make our dreams come true.

So let this poem inspire you,
To find your own path, to chase your dreams,
For in their embrace, we find
Our strength, our courage, and our guide.

And though the road may be long,
But with every step, we grow,
And in the
=========================

</pre></div></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="5_initial_train_behaviour.html" class="btn btn-neutral float-left" title="Evaluating Trained LLM Performance on Time Series Forecasting" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="7_weight_visualize.html" class="btn btn-neutral float-right" title="LM Bias Weight Visualization" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Yuchen Mao.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>